function initWordGame(){let w={gridCols:12,gridRows:8,minWordLength:4,maxWordLength:8,wordCount:{easy:6,medium:8,hard:10},maxPlacementAttempts:200,maxTotalAttempts:1e3,maxRetries:3},f=[],g=[],u=[],m=[],o=!1;var e=(()=>{var e=localStorage.getItem("wordGameState");if(e)try{var t=JSON.parse(e);if(["easy","medium","hard"].includes(t.difficulty)&&"number"==typeof t.consecutiveWins&&"number"==typeof t.currentLevel)return t}catch(e){console.error("Invalid saved game state",e)}return null})();let p=e?.difficulty||"easy",n=e?.consecutiveWins||0,a=e?.currentLevel||1,v=new Set,t=0,E={horizontal:0,vertical:0,diagonal:0},C=document.getElementById("wordsearch-grid"),y=document.getElementById("wordsearch-wordlist"),r=document.getElementById("wordsearch-words-left"),l=document.getElementById("wordsearch-feedback");var e=document.getElementById("wordsearch-new"),d=document.getElementById("wordsearch-hint");let i=document.createElement("span"),s=(i.id="wordsearch-level",document.createElement("span"));s.id="wordsearch-games-remaining",l||((l=document.createElement("div")).id="wordsearch-feedback",l.className="word-feedback",document.querySelector(".game-body").appendChild(l));var c=document.querySelector(".word-game-meta");async function L(){A("","info"),C.innerHTML="",y.innerHTML="",m=[],u=[],o=!1,v.clear(),E={horizontal:0,vertical:0,diagonal:0};try{(g=await T(w)).sort((e,t)=>t.letters.length-e.letters.length),console.log("Words fetched and sorted:",g);let o=!1,l=0;for(;!o&&l<3;){l++,console.log(`Attempt ${l} to place all words`),f=Array(w.gridCols*w.gridRows).fill().map(()=>({letter:"",element:null,word:null}));let e=[],t=0,r=[...g];for(var n=w.wordCount[p],a=Math.floor(n/3),d={horizontal:a,vertical:a,diagonal:n-2*a};e.length<w.wordCount[p]&&t<w.maxTotalAttempts;){0===r.length&&(r=[...g].filter(t=>!e.some(e=>e.word===t.word)),console.log("Resetting available words:",r));var i=r[0];R(i,d)?(e.push(i),v.add(i.word),r.shift(),console.log(`Placed word: ${i.word}, Total placed: `+e.length)):(r.shift(),console.log(`Failed to place word: ${i.word}, Moving to next word`),t++)}if((g=e).length<w.wordCount[p]){console.warn(`Only placed ${g.length} out of ${w.wordCount[p]} words`);var s=w.wordCount[p]-g.length,c=(await T(w,s)).filter(e=>!v.has(e.word));let e=0;for(;g.length<w.wordCount[p]&&e<w.maxTotalAttempts&&0<c.length;){var h=c[0];R(h,d)?(g.push(h),v.add(h.word),c.shift(),console.log(`Simpler placement: Placed word: ${h.word}, Total placed: `+g.length)):(c.shift(),e++,console.log("Simpler placement failed for: "+h.word))}}g.length===w.wordCount[p]?o=!0:(console.warn("Failed to place all words on attempt "+l),v.clear(),(g=await T(w)).sort((e,t)=>t.letters.length-e.letters.length),E={horizontal:0,vertical:0,diagonal:0})}if(!o)throw new Error(`Could only place ${g.length} out of ${w.wordCount[p]} words after 3 attempts`);{let r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";f.forEach((e,t)=>{""===e.letter&&(e.letter=r[Math.floor(Math.random()*r.length)])}),console.log("Grid after filling empty cells:",f)}console.log(`Rendering grid with ${w.gridCols} cols and ${w.gridRows} rows`),C.style.setProperty("--cols",w.gridCols),C.style.setProperty("--rows",w.gridRows),C.style.display="grid",C.style.width="100%",C.style.maxWidth="100%",C.style.overflow="hidden",C.innerHTML="",f.forEach((e,t)=>{var r=document.createElement("div");r.className="wordsearch-cell",r.textContent=e.letter,r.dataset.index=t,r.addEventListener("mousedown",I),r.addEventListener("mouseenter",e=>{e.preventDefault(),O(e)}),r.addEventListener("mouseup",D),r.addEventListener("touchstart",U,{passive:!1}),r.addEventListener("touchmove",P,{passive:!1}),r.addEventListener("touchend",$),C.appendChild(r),e.element=r}),y.innerHTML="",g.forEach(e=>{var t=document.createElement("div");t.className="wordsearch-word",t.textContent=e.word,t.dataset.word=e.word,y.appendChild(t)}),M(),S(),A(`Find ${g.length} hidden words!`,"info"),t=0}catch(e){if(console.error("Game initialization failed:",e),A("Failed to load puzzle. Retrying...","error"),++t>=w.maxRetries)return void A("Failed to load puzzle after multiple attempts. Please refresh the page.","error");setTimeout(()=>{var e=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=w.minWordLength&&e.length<=w.maxWordLength),e=[...new Set(e)].filter(e=>!v.has(e));(g=N(e).slice(0,w.wordCount[p]).map(e=>({word:e,letters:e.split("")}))).sort((e,t)=>t.letters.length-e.letters.length),L()},2e3)}"undefined"!=typeof gtag&&gtag("event","word_search_started",{event_category:"word_search",event_label:1,value:void 0})}async function T({minWordLength:o,maxWordLength:l,wordCount:n},a=null){try{var d=Math.floor(9e5*Math.random()),i=a||3*n[p],e=await db.collection("dictionary").where("length",">=",o).where("length","<=",l).where("randomIndex",">=",d).orderBy("randomIndex").limit(i).get();if(e.empty)throw new Error("No words found in dictionary");let t=new Set,r=[];if(e.forEach(e=>{var e=e.data();e.word&&e.letters&&(e=e.word.toUpperCase(),v.has(e)||(t.add(e),r.push({word:e,letters:e.split("").map(e=>e.toUpperCase())})))}),0===t.size)throw new Error("No valid words found");var s=N(r).slice(0,a||n[p]);return console.log("Generated word list:",s),s}catch(e){console.error("Error fetching words:",e);d=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=o&&e.length<=l),i=N([...new Set(d)].filter(e=>!v.has(e))).slice(0,a||n[p]).map(e=>({word:e,letters:e.split("")}));return console.log("Fallback word list:",i),i}}function R(t,r){var o,e=[{id:0,type:"horizontal",rowStep:0,colStep:1},{id:1,type:"vertical",rowStep:1,colStep:0},{id:2,type:"diagonal",rowStep:1,colStep:1},{id:3,type:"diagonal",rowStep:-1,colStep:1}],l=e.filter(e=>!("horizontal"===e.type&&E.horizontal>=r.horizontal||"vertical"===e.type&&E.vertical>=r.vertical||"diagonal"===e.type&&E.diagonal>=r.diagonal));for(o of N([...0<l.length?l:e]))for(let e=0;e<50;e++){var n=0===o.rowStep?w.gridRows:w.gridRows-t.letters.length*Math.abs(o.rowStep),a=0===o.colStep?w.gridCols:w.gridCols-t.letters.length*Math.abs(o.colStep),n=Math.floor(Math.random()*n),a=Math.floor(Math.random()*a);if(((e,o,l,n)=>{var a=e.letters;for(let r=0;r<a.length;r++){let e=o,t=l;switch(n){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}if(e<0||e>=w.gridRows||t<0||t>=w.gridCols)return;var d=e*w.gridCols+t;if(""!==f[d].letter&&f[d].letter!==a[r])return}return 1})(t,n,a,o.id)){u=g=h=c=s=i=d=void 0;var d=t,i=n,s=a,c=o.id,{word:h,letters:g}=d;for(let r=0;r<g.length;r++){let e=i,t=s;switch(c){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}var u=e*w.gridCols+t;f[u].letter=g[r],f[u].word=h}return"horizontal"===o.type?E.horizontal++:"vertical"===o.type?E.vertical++:"diagonal"===o.type&&E.diagonal++,console.log(`Placed ${t.word} in ${o.type} direction at (${n}, ${a})`),1}}console.log(`Failed to place ${t.word} after trying all directions`)}function h(){if(!(m.length<w.minWordLength)){var e=m.map(e=>f[e].letter).join(""),l=e.split("").reverse().join("");let t=e.toUpperCase(),r=l.toUpperCase(),o=g.find(e=>e.word.toUpperCase()===t||e.word.toUpperCase()===r);o&&!u.includes(o.word)?(u.push(o.word),m.forEach(e=>{f[e].element.classList.remove("selected"),f[e].element.classList.add("found")}),y.querySelectorAll(".wordsearch-word").forEach(e=>{e.dataset.word===o.word&&e.classList.add("found")}),M(),A("Found: "+o.word,"success"),u.length===g.length&&(3<=++n?("easy"===p?(p="medium",A("Advanced to Medium level!","success")):"medium"===p?(p="hard",A("Advanced to Hard level!","success")):A("Mastered all levels!","success"),n=0,a++):A(`Great job! ${3-n} more wins to advance.`,"info"),S(),e={difficulty:p,consecutiveWins:n,currentLevel:a},localStorage.setItem("wordGameState",JSON.stringify(e)),setTimeout(L,2e3))):A("Word not found in list","error")}m=[],x()}function S(){i.textContent=`Level: ${a} (${p})`;var e=3-n;s.textContent=0<e?"Wins to next level: "+e:"Ready to advance!"}function M(){r.textContent=`Words: ${g.length-u.length}/`+g.length}function A(e,t){l.textContent=e,l.className="word-feedback "+t}function N(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}function I(e){e.preventDefault(),o=!0;e=b(e.target);null!==e&&(m=[e],x())}function O(e){var t,r;e.preventDefault(),!o||0===m.length||null===(e=b(e.target))||m.includes(e)||(t=m[m.length-1],r=(()=>{if(!(m.length<2)){var e=m[0],t=m[1],r=Math.floor(e/w.gridCols),e=e%w.gridCols,o=Math.floor(t/w.gridCols),t=t%w.gridCols,o=o-r,r=t-e;if(0==o&&0!=r)return{row:0,col:0<r?1:-1};if(0==r&&0!=o)return{row:0<o?1:-1,col:0};if(Math.abs(o)===Math.abs(r))return{row:0<o?1:-1,col:0<r?1:-1}}return null})(),1<m.length&&!((e,t,r)=>{var o,l;if(r)return l=Math.floor(e/w.gridCols),e%=w.gridCols,o=Math.floor(t/w.gridCols),t%=w.gridCols,o-=l,l=t-e,0===r.row?0==o&&l===r.col:0===r.col?0==l&&o===r.row:Math.sign(o)===Math.sign(r.row)&&Math.sign(l)===Math.sign(r.col)&&Math.abs(o)===Math.abs(l)})(t,e,r))||(m.push(e),x())}function D(){o&&(o=!1,h())}function b(e){return e.classList.contains("wordsearch-cell")?parseInt(e.dataset.index):null}function x(){f.forEach(e=>{e.element.classList.remove("selected")}),m.forEach(e=>{f[e].element.classList.add("selected")})}function U(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&I({target:e,preventDefault:()=>{}})}function P(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&O({target:e,preventDefault:()=>{}})}function $(e){e.preventDefault(),D()}c&&(c.appendChild(i),c.appendChild(s)),L(),e.addEventListener("click",L),d.addEventListener("click",function(){var e=g.filter(e=>!u.includes(e.word));0<e.length?A(`Try looking for a word starting with ${e[Math.floor(Math.random()*e.length)].word.slice(0,2)}...`,"info"):A("You found all words!","success")})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
