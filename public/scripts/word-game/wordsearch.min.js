function initWordGame(){let m={gridCols:12,gridRows:8,minWordLength:4,maxWordLength:8,wordCount:{easy:6,medium:8,hard:10},maxPlacementAttempts:200,maxTotalAttempts:1e3,maxRetries:3},u=[],g=[],w=[],f=[],p=!1,E="easy",a=0,n=1,C=new Set,t=0,v={horizontal:0,vertical:0,diagonal:0},T=document.getElementById("wordsearch-grid"),R=document.getElementById("wordsearch-wordlist"),e=document.getElementById("wordsearch-words-left"),o=document.getElementById("wordsearch-feedback");var r=document.getElementById("wordsearch-new"),l=document.getElementById("wordsearch-hint");let d=document.createElement("span"),i=(d.id="wordsearch-level",document.createElement("span"));i.id="wordsearch-games-remaining",o||((o=document.createElement("div")).id="wordsearch-feedback",o.className="word-feedback",document.querySelector(".game-body").appendChild(o));var s=document.querySelector(".word-game-meta");async function L(){T.innerHTML="",R.innerHTML="",f=[],w=[],p=!1,C.clear(),v={horizontal:0,vertical:0,diagonal:0};try{(g=await M(m)).sort((e,t)=>t.letters.length-e.letters.length),console.log("Words fetched and sorted:",g);let r=!1,l=0;for(;!r&&l<3;){l++,console.log(`Attempt ${l} to place all words`),u=Array(m.gridCols*m.gridRows).fill().map(()=>({letter:"",element:null,word:null}));let e=[],t=0,o=[...g];for(var a=m.wordCount[E],n=Math.floor(a/3),d={horizontal:n,vertical:n,diagonal:a-2*n};e.length<m.wordCount[E]&&t<m.maxTotalAttempts;){0===o.length&&(o=[...g].filter(t=>!e.some(e=>e.word===t.word)),console.log("Resetting available words:",o));var i=o[0];y(i,d)?(e.push(i),C.add(i.word),o.shift(),console.log(`Placed word: ${i.word}, Total placed: `+e.length)):(o.shift(),console.log(`Failed to place word: ${i.word}, Moving to next word`),t++)}if((g=e).length<m.wordCount[E]){console.warn(`Only placed ${g.length} out of ${m.wordCount[E]} words`);var s=m.wordCount[E]-g.length,c=(await M(m,s)).filter(e=>!C.has(e.word));let e=0;for(;g.length<m.wordCount[E]&&e<m.maxTotalAttempts&&0<c.length;){var h=c[0];y(h,d)?(g.push(h),C.add(h.word),c.shift(),console.log(`Simpler placement: Placed word: ${h.word}, Total placed: `+g.length)):(c.shift(),e++,console.log("Simpler placement failed for: "+h.word))}}g.length===m.wordCount[E]?r=!0:(console.warn("Failed to place all words on attempt "+l),C.clear(),(g=await M(m)).sort((e,t)=>t.letters.length-e.letters.length),v={horizontal:0,vertical:0,diagonal:0})}if(!r)throw new Error(`Could only place ${g.length} out of ${m.wordCount[E]} words after 3 attempts`);{let o="ABCDEFGHIJKLMNOPQRSTUVWXYZ";u.forEach((e,t)=>{""===e.letter&&(e.letter=o[Math.floor(Math.random()*o.length)])}),console.log("Grid after filling empty cells:",u)}console.log(`Rendering grid with ${m.gridCols} cols and ${m.gridRows} rows`),T.style.display="grid",T.style.gridTemplateColumns=`repeat(${m.gridCols}, 1fr)`,T.style.gridTemplateRows=`repeat(${m.gridRows}, 1fr)`,T.innerHTML="",u.forEach((e,t)=>{var o=document.createElement("div");o.className="wordsearch-cell",o.textContent=e.letter,o.dataset.index=t,o.addEventListener("mousedown",I),o.addEventListener("mouseenter",e=>{var t,o;e.preventDefault(),(e=e).preventDefault(),!p||0===f.length||null===(e=$(e.target))||f.includes(e)||(t=f[f.length-1],o=(()=>{if(!(f.length<2)){var e=f[0],t=f[1],o=Math.floor(e/m.gridCols),e=e%m.gridCols,r=Math.floor(t/m.gridCols),t=t%m.gridCols,r=r-o,o=t-e;if(0==r&&0!=o)return{row:0,col:0<o?1:-1};if(0==o&&0!=r)return{row:0<r?1:-1,col:0};if(Math.abs(r)===Math.abs(o))return{row:0<r?1:-1,col:0<o?1:-1}}return null})(),1<f.length&&!((e,t,o)=>{var r,l;if(o)return l=Math.floor(e/m.gridCols),e%=m.gridCols,r=Math.floor(t/m.gridCols),t%=m.gridCols,r-=l,l=t-e,0===o.row?0==r&&l===o.col:0===o.col?0==l&&r===o.row:Math.sign(r)===Math.sign(o.row)&&Math.sign(l)===Math.sign(o.col)&&Math.abs(r)===Math.abs(l)})(t,e,o))||(f.push(e),b())}),o.addEventListener("mouseup",U),T.appendChild(o),e.element=o}),R.innerHTML="",g.forEach(e=>{var t=document.createElement("div");t.className="wordsearch-word",t.textContent=e.word,t.dataset.word=e.word,R.appendChild(t)}),A(),S(),N(`Find ${g.length} hidden words!`,"info"),t=0}catch(e){console.error("Game initialization failed:",e),N("Failed to load puzzle. Retrying...","error"),++t>=m.maxRetries?N("Failed to load puzzle after multiple attempts. Please refresh the page.","error"):setTimeout(()=>{var e=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=m.minWordLength&&e.length<=m.maxWordLength),e=[...new Set(e)].filter(e=>!C.has(e));(g=O(e).slice(0,m.wordCount[E]).map(e=>({word:e,letters:e.split("")}))).sort((e,t)=>t.letters.length-e.letters.length),L()},2e3)}}async function M({minWordLength:r,maxWordLength:l,wordCount:a},n=null){try{var d=n||3*a[E],i=await db.collection("dictionary").where("length",">=",r).where("length","<=",l).limit(d).get();if(i.empty)throw new Error("No words found in dictionary");let t=new Set,o=[];if(i.forEach(e=>{var e=e.data();e.word&&e.letters&&(e=e.word.toUpperCase(),C.has(e)||(t.add(e),o.push({word:e,letters:e.split("").map(e=>e.toUpperCase())})))}),0===t.size)throw new Error("No valid words found");var e=O(o).slice(0,n||a[E]);return console.log("Generated word list:",e),e}catch(e){console.error("Error fetching words:",e);d=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=r&&e.length<=l),i=O([...new Set(d)].filter(e=>!C.has(e))).slice(0,n||a[E]).map(e=>({word:e,letters:e.split("")}));return console.log("Fallback word list:",i),i}}function y(t,o){var r,e=[{id:0,type:"horizontal",rowStep:0,colStep:1},{id:1,type:"vertical",rowStep:1,colStep:0},{id:2,type:"diagonal",rowStep:1,colStep:1},{id:3,type:"diagonal",rowStep:-1,colStep:1}],l=e.filter(e=>!("horizontal"===e.type&&v.horizontal>=o.horizontal||"vertical"===e.type&&v.vertical>=o.vertical||"diagonal"===e.type&&v.diagonal>=o.diagonal));for(r of O([...0<l.length?l:e]))for(let e=0;e<50;e++){var a=0===r.rowStep?m.gridRows:m.gridRows-t.letters.length*Math.abs(r.rowStep),n=0===r.colStep?m.gridCols:m.gridCols-t.letters.length*Math.abs(r.colStep),a=Math.floor(Math.random()*a),n=Math.floor(Math.random()*n);if(((e,r,l,a)=>{var n=e.letters;for(let o=0;o<n.length;o++){let e=r,t=l;switch(a){case 0:t+=o;break;case 1:e+=o;break;case 2:e+=o,t+=o;break;case 3:e-=o,t+=o}if(e<0||e>=m.gridRows||t<0||t>=m.gridCols)return;var d=e*m.gridCols+t;if(""!==u[d].letter&&u[d].letter!==n[o])return}return 1})(t,a,n,r.id)){w=g=h=c=s=i=d=void 0;var d=t,i=a,s=n,c=r.id,{word:h,letters:g}=d;for(let o=0;o<g.length;o++){let e=i,t=s;switch(c){case 0:t+=o;break;case 1:e+=o;break;case 2:e+=o,t+=o;break;case 3:e-=o,t+=o}var w=e*m.gridCols+t;u[w].letter=g[o],u[w].word=h}return"horizontal"===r.type?v.horizontal++:"vertical"===r.type?v.vertical++:"diagonal"===r.type&&v.diagonal++,console.log(`Placed ${t.word} in ${r.type} direction at (${a}, ${n})`),1}}console.log(`Failed to place ${t.word} after trying all directions`)}function c(){if(!(f.length<m.minWordLength)){var e=f.map(e=>u[e].letter).join(""),l=e.split("").reverse().join("");let t=e.toUpperCase(),o=l.toUpperCase(),r=g.find(e=>e.word.toUpperCase()===t||e.word.toUpperCase()===o);r&&!w.includes(r.word)?(w.push(r.word),f.forEach(e=>{u[e].element.classList.remove("selected"),u[e].element.classList.add("found")}),R.querySelectorAll(".wordsearch-word").forEach(e=>{e.dataset.word===r.word&&e.classList.add("found")}),A(),N("Found: "+r.word,"success"),w.length===g.length&&(3<=++a?("easy"===E?(E="medium",N("Advanced to Medium level!","success")):"medium"===E?(E="hard",N("Advanced to Hard level!","success")):N("Mastered all levels!","success"),a=0,n++):N(`Great job! ${3-a} more wins to advance.`,"info"),S(),setTimeout(L,2e3))):N("Word not found in list","error")}f=[],b()}function S(){d.textContent=`Level: ${n} (${E})`,i.textContent="Wins to next level: "+(3-a)}function A(){e.textContent=`Words: ${g.length-w.length}/`+g.length}function N(e,t){o.textContent=e,o.className="word-feedback "+t}function O(e){var t=[...e];for(let e=t.length-1;0<e;e--){var o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}function I(e){e.preventDefault(),p=!0;e=$(e.target);null!==e&&(f=[e],b())}function U(){p&&(p=!1,c())}function $(e){return e.classList.contains("wordsearch-cell")?parseInt(e.dataset.index):null}function b(){u.forEach(e=>{e.element.classList.remove("selected")}),f.forEach(e=>{u[e].element.classList.add("selected")})}s&&(s.appendChild(d),s.appendChild(i)),L(),r.addEventListener("click",L),l.addEventListener("click",function(){var e=g.filter(e=>!w.includes(e.word));0<e.length?N(`Try looking for a word starting with ${e[Math.floor(Math.random()*e.length)].word.slice(0,2)}...`,"info"):N("You found all words!","success")})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
