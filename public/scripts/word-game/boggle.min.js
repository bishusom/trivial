function initWordGame(){var e=(()=>{var e=localStorage.getItem("boggleGameState");if(e)try{var t=JSON.parse(e);if(["easy","medium","hard"].includes(t.difficulty)&&"number"==typeof t.consecutiveWins&&"number"==typeof t.currentLevel)return t}catch(e){console.error("Invalid saved game state",e)}return null})();let u=e?.difficulty||"easy",a=e?.consecutiveWins||0,m=e?.currentLevel||1,g=0,o=180,h=null,f=[],p={gridSize:{easy:4,medium:5,hard:5},minWordLength:{easy:3,medium:3,hard:3},maxWordLength:{easy:4,medium:4,hard:5},timeLimit:{easy:240,medium:300,hard:360},scorePerLetter:{easy:10,medium:15,hard:20},winThreshold:{easy:100,medium:200,hard:300},vowelPercentage:{easy:.4,medium:.35,hard:.3}},n=["CAT","DOG","HAT","RUN","SUN","PEN","RED","BLUE","TREE","BIRD","FISH","STAR","MOON","PLAY","BOOK","FOOD","GOOD","LOVE","HOME","TIME","BALL","GAME","CARS","SHIP","WIND","RAIN","SNOW","FIRE","WAVE","HILL","HOUSE","TABLE","CHAIR","WINDOW","DOOR","FLOOR"].map(e=>e.toUpperCase()),v=[],y=new Set,L=[],w=!1,E=new Set,M=new Map,l=0,r={select:new Audio("/audio/click.mp3"),found:new Audio("/audio/correct.mp3"),win:new Audio("/audio/victory.mp3"),error:new Audio("/audio/wrong.mp3")},i=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,t=document.querySelector("#mute-btn .material-icons"),S=document.getElementById("boggle-grid"),C=document.getElementById("boggle-word-list"),d=document.getElementById("boggle-feedback");var e=document.getElementById("boggle-new"),P=document.getElementById("boggle-hint");let A=document.getElementById("boggle-time"),D=document.getElementById("boggle-score"),F=document.getElementById("boggle-level"),s=document.createElement("span");function b(t){i?console.log(`Sound ${t} skipped: muted`):(console.log("Playing sound: "+t),r[t]&&(r[t].currentTime=0,r[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e))))}function c(){Object.keys(r).forEach(e=>{e=e,r[e]&&(r[e].pause(),r[e].currentTime=0)})}function I(e,t,r,o){"undefined"!=typeof gtag&&gtag("event",e,{event_category:t,event_label:r,value:o})}function x(){var e={difficulty:u,consecutiveWins:a,currentLevel:m};localStorage.setItem("boggleGameState",JSON.stringify(e))}async function $(){console.log("Initializing Boggle game with state:",{difficulty:u,currentLevel:m,consecutiveWins:a});try{var e=Math.floor(1e4*Math.random()),t=await db.collection("dictionary").where("length",">=",p.minWordLength[u]).where("length","<=",p.maxWordLength[u]).where("randomIndex",">=",e).orderBy("randomIndex").limit(50).get();f=t.docs.map(e=>e.data().word.toUpperCase()),console.log(`Fetched ${f.length} words from Firebase`)}catch(e){console.error("Error fetching words from Firebase:",e),f=n}await 0;var r,e=document.querySelector(".selection-line");e&&e.remove(),clearInterval(h),o=p.timeLimit[u],g=0,y.clear(),L=[],w=!1,E.clear(),M.clear(),S.innerHTML="",C.innerHTML="",N(`
      <div class="instructions">
        <h3>How to Play Boggle</h3>
        <p>Find words by selecting adjacent letters (horizontally, vertically, or diagonally).</p>
        <p>Words must be ${p.minWordLength[u]}–${p.maxWordLength[u]} letters long.</p>
        <p>Score ${p.scorePerLetter[u]} points per letter. Reach ${p.winThreshold[u]} points to win!</p>
        <p>Time limit: ${Math.floor(p.timeLimit[u]/60)} minutes.</p>
      </div>
    `,"info"),W(),O(),z(),clearInterval(h),h=setInterval(()=>{o--,z()},1e3);try{{let t=p.gridSize[u],r="AEIOU",o=Math.ceil(t*t*p.vowelPercentage[u]),n=0,a=(v=[],[]);f.forEach(e=>{e.split("").forEach(e=>a.push(e))}),["S","T","B","C","D","F","G","H","L","M","N","P","R"].forEach(e=>a.push(e)),["TH","CH","SH","QU","BR","CR","DR","FR","GR","PR","TR"].forEach(e=>{a.push(e[0]),a.push(e[1])});for(let e=0;e<30;e++)a.push(r[Math.floor(Math.random()*r.length)]);var l="hard"===u?"JQXZ":"JQX";for(let e=0;e<40;e++){var i=Math.random()<.8?"BCDFGHKLMNPRSTVWY":l;a.push(i[Math.floor(Math.random()*i.length)])}let e=0;for(;e<5;){v=[];for(let e=n=0;e<t*t;e++){var d=Math.floor(e/t),s=e%t;(0<d&&d<t-1&&0<s&&s<t-1||n<o)&&(n<o||Math.random()<.6)?(d=r[Math.floor(Math.random()*r.length)],v.push({letter:d,element:null}),n++):(s=Math.floor(Math.random()*a.length),v.push({letter:a[s],element:null}))}if("hard"!==u||(()=>{let t=v.map(e=>e.letter).join(""),e=["STR","THR","SPL","SPR","SCR","SHR","PHL","CHR"].filter(e=>t.includes(e)).length,o=0,n=p.gridSize[u];for(let r=0;r<v.length;r++){var a,l=Math.floor(r/n),i=r%n;if("AEIOU".includes(v[r].letter))for(let t=l-1;t<=l+1;t++)for(let e=i-1;e<=1+i;e++)0<=t&&t<n&&0<=e&&e<n&&(a=t*n+e)!==r&&"AEIOU".includes(v[a].letter)&&o++}return 3<=e&&o<=2*n})())break;e++}var c=v.filter(e=>r.includes(e.letter)).length;console.log(`Generated ${t}x${t} grid with ${c} vowels`),v}r=p.gridSize[u],S.style.gridTemplateColumns=`repeat(${r}, 1fr)`,S.style.gridTemplateRows=`repeat(${r}, 1fr)`,S.style.setProperty("--grid-size",r),S.style.display="grid",S.style.width="100%",S.style.maxWidth="100%",S.style.overflow="hidden",v.forEach((e,t)=>{var r=document.createElement("div");r.className="boggle-cell",r.textContent=e.letter,r.dataset.index=t,r.addEventListener("mousedown",G),r.addEventListener("mouseenter",e=>{_(e),b("select")}),r.addEventListener("mouseup",j),r.addEventListener("touchstart",V,{passive:!1}),r.addEventListener("touchmove",X,{passive:!1}),r.addEventListener("touchend",Y),S.appendChild(r),e.element=r}),I("boggle_game_started","boggle","start",1)}catch(e){console.error("Game initialization failed:",e),N("Failed to load puzzle. Please refresh the page.","error"),b("error")}}function T(e){var e=v[e].element.getBoundingClientRect(),t=S.getBoundingClientRect();return{x:e.left+e.width/2-t.left,y:e.top+e.height/2-t.top}}async function k(){if(L.length<p.minWordLength[u])N("Word too short","error"),b("error");else{var t,r=L.map(e=>v[e].letter).join("");if(y.has(r))N("Word already found","error"),b("error");else try{let e=!1;if(M.has(r.toLowerCase())?e=M.get(r.toLowerCase()):(t=await fetch("https://api.dictionaryapi.dev/api/v2/entries/en/"+r.toLowerCase()),e=t.ok,M.set(r.toLowerCase(),e)),e&&r.length>=p.minWordLength[u]&&r.length<=p.maxWordLength[u]){y.add(r);var o=r.length*p.scorePerLetter[u];if(g+=o,L.forEach(e=>v[e].element.classList.add("found")),R(),W(),N(`Found: ${r} (+${o} points)`,"success"),b("found"),I("word_found","boggle",r,o),g>=p.winThreshold[u]){clearInterval(h),b("win");let e=document.createElement("div"),t=(e.className="victory-screen",H(),a++,""),r=(3<=a?("easy"===u?(u="medium",t="🎉 Advanced to Medium level! 🎉",setTimeout(()=>H({particleCount:200,spread:100}),1e3)):"medium"===u?(u="hard",t="🏆 Advanced to Hard level! 🏆",setTimeout(()=>H({particleCount:300,spread:120,shapes:["circle","square"]}),1e3)):(t="👑 Mastered all levels! 👑",setTimeout(()=>H({particleCount:400,spread:150,shapes:["circle","square","star"]}),1e3),setTimeout(()=>H({particleCount:400,spread:150,origin:{x:0}}),1500),setTimeout(()=>H({particleCount:400,spread:150,origin:{x:1}}),2e3)),a=0,m++):t="hard"==u?"🎊 Great job in tackling this hard level!🎊":`🎊 Great job! ${3-a} more wins to advance. 🎊`,e.innerHTML=`
      <h2>Victory!</h2>
      <p>${t}</p>
      <p>Score: ${g}</p>
      <p>Words Found: ${y.size}</p>
      <div class="countdown">Next game starting in 5...</div>
    `,document.body.appendChild(e),5),o=e.querySelector(".countdown"),n=setInterval(()=>{r--,o.textContent=`Next game starting in ${r}...`,r<=0&&(clearInterval(n),e.remove(),x(),O(),$())},1e3);I("level_complete","boggle",u,g),x(),O()}}else N("Not a valid word","error"),b("error")}catch(e){console.error("Error checking word:",e),n.includes(r.toUpperCase())?(y.add(r),t=r.length*p.scorePerLetter[u],g+=t,L.forEach(e=>v[e].element.classList.add("found")),R(),W(),N(`Found: ${r} (+${t} points)`,"success"),b("found"),I("word_found","boggle",r,t)):(N("Error checking word, try another","error"),b("error"))}}L=[],B()}function R(){C.innerHTML="",Array.from(y).sort().forEach(e=>{var t=document.createElement("li");t.textContent=e,C.appendChild(t)})}function W(){D.textContent="Score: "+g}function O(){var e;F.textContent=`Level: ${m} (${u})`,"hard"!==u?(e=3-a,s.textContent=0<e?"Wins to next difficulty: "+e:"Ready to advance difficulty!"):s.textContent="Max difficulty reached!"}function z(){var e=Math.floor(o/60),t=o%60;A.textContent=`Time: ${e}:`+t.toString().padStart(2,"0"),o<=0&&(clearInterval(h),N("Time’s up!","error"),b("error"),setTimeout($,2e3))}function H(e={}){let t={particleCount:100,spread:70,origin:{y:.6},colors:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]};confetti({...t,...e}),.5<Math.random()&&setTimeout(()=>{confetti({...t,...e,angle:180*Math.random()-90,origin:{x:Math.random(),y:.6}})},300)}function N(e,t){d.innerHTML=e,d.className="word-feedback "+t}function G(e){e.preventDefault(),w=!0;e=q(e.target);null!==e&&(L=[e],E=new Set([e]),B(),U(e),b("select"),console.log(`Selection started at index ${e} (${v[e].letter}) at (${Math.floor(e/5)}, ${e%5})`))}function _(e){var t,r,o;e.preventDefault(),!w||0===L.length||(t=Date.now())-l<20||(l=t,null===(t=q(e.target)))||E.has(t)||(e=L[L.length-1],r=p.gridSize[u],console.log(`Checking adjacency between: 
      ${e} (${v[e].letter}) at (${Math.floor(e/r)},${e%r}) and 
      ${t} (${v[t].letter}) at (${Math.floor(t/r)},${t%r})`),r=t,e=J(e=e),r=J(r),o=Math.abs(r.row-e.row),r=Math.abs(r.col-e.col),o<=1&&r<=1&&(0!==o||0!==r)?(L.push(t),E.add(t),B(),U(t)):console.log("Not adjacent - row/col diff too large"))}function j(){var e;w&&(w=!1,v.forEach(e=>e.element.classList.remove("adjacent")),(e=document.querySelector(".selection-line"))&&e.remove(),(L.length<2?(N("Selection too short, please select at least 2 letters","error"),b("error"),L=[],B):k)())}function U(e){v.forEach(e=>e.element.classList.remove("adjacent"));var r,o=p.gridSize[u],n=Math.floor(e/o),a=e%o;for(let t=n-1;t<=n+1;t++)for(let e=a-1;e<=1+a;e++)t===n&&e===a||t<0||t>=o||e<0||e>=o||(r=t*o+e,E.has(r))||v[r].element.classList.add("adjacent")}function q(e){return e.classList.contains("boggle-cell")?parseInt(e.dataset.index):null}function J(e){var t=p.gridSize[u];return{row:Math.floor(e/t),col:e%t}}function B(){v.forEach(e=>{e.element.classList.remove("selected","highlight")}),L.forEach(e=>{v[e].element&&(v[e].element.classList.add("selected"),e===L[L.length-1])&&v[e].element.classList.add("highlight")});var e=document.querySelector(".selection-line");if(e&&e.remove(),!(L.length<2)){e=document.createElement("div");e.className="selection-line",S.appendChild(e);for(let e=0;e<L.length-1;e++){var t=T(L[e]),r=T(L[e+1]),o=Math.sqrt(Math.pow(r.x-t.x,2)+Math.pow(r.y-t.y,2)),r=180*Math.atan2(r.y-t.y,r.x-t.x)/Math.PI,n=document.createElement("div");n.className="selection-line",n.style.width=o+"px",n.style.left=t.x+"px",n.style.top=t.y+"px",n.style.transform=`rotate(${r}deg)`,S.appendChild(n)}}}function V(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("boggle-cell")&&G({target:e,preventDefault:()=>{}})}function X(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("boggle-cell")&&_({target:e,preventDefault:()=>{}})}function Y(e){e.preventDefault(),j()}s.id="boggle-games-remaining",document.querySelector(".word-game-meta").appendChild(s),$(),i=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,t&&(t.textContent=i?"volume_off":"volume_up"),i&&c();var Q=document.getElementById("mute-btn");Q&&Q.addEventListener("click",()=>{i=!i,localStorage.setItem("triviaMasterMuteState",i),t&&(t.textContent=i?"volume_off":"volume_up"),i&&c()}),e.addEventListener("click",$),P.addEventListener("click",async function(){var e;0<y.size?(N("Try finding more words first!","info"),b("error")):(N("Looking for a hint...","info"),(e=f[Math.floor(Math.random()*f.length)])?(N("Hint: Try finding a word starting with "+e[0],"success"),b("found"),I("hint_used","boggle",u,m)):(N("No hints available","error"),b("error")))})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
