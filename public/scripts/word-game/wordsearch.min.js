function initWordGame(){var e=(()=>{var e=localStorage.getItem("wordGameState");if(e)try{var t=JSON.parse(e);if(["easy","medium","hard"].includes(t.difficulty)&&"number"==typeof t.consecutiveWins&&"number"==typeof t.currentLevel)return t}catch(e){console.error("Invalid saved game state",e)}return null})();let u=e?.difficulty||"easy",g=e?.consecutiveWins||0,f=e?.currentLevel||1,m={gridCols:12,gridRows:8,minWordLength:4,maxWordLength:8,wordCount:{easy:6,medium:8,hard:10},maxPlacementAttempts:200,maxTotalAttempts:1e3,maxRetries:3},w=[],p=[],v=[],E=[],o=!1,C=new Set,t=0,y={horizontal:0,vertical:0,diagonal:0},L=document.getElementById("wordsearch-grid"),T=document.getElementById("wordsearch-wordlist"),r=document.getElementById("wordsearch-words-left"),l=document.getElementById("wordsearch-feedback");var e=document.getElementById("wordsearch-new"),n=document.getElementById("wordsearch-hint");let S=document.getElementById("wordsearch-level"),M=document.getElementById("wordsearch-games-remaining");l||((l=document.createElement("div")).id="wordsearch-feedback",l.className="word-feedback",document.querySelector(".game-body").appendChild(l));var a=document.querySelector(".word-game-meta");async function R(){console.log("Initializing game with state:",{difficulty:u,currentLevel:f,consecutiveWins:g}),D("","info"),L.innerHTML="",T.innerHTML="",E=[],v=[],o=!1,C.clear(),y={horizontal:0,vertical:0,diagonal:0};var e=document.querySelector(".word-game-meta");e&&!document.getElementById("wordsearch-level")&&(e.appendChild(S),e.appendChild(M)),N();try{(p=await A(m)).sort((e,t)=>t.letters.length-e.letters.length),console.log("Words fetched and sorted:",p);let o=!1,l=0;for(;!o&&l<3;){l++,console.log(`Attempt ${l} to place all words`),w=Array(m.gridCols*m.gridRows).fill().map(()=>({letter:"",element:null,word:null}));let e=[],t=0,r=[...p];for(var n=m.wordCount[u],a=Math.floor(n/3),d={horizontal:a,vertical:a,diagonal:n-2*a};e.length<m.wordCount[u]&&t<m.maxTotalAttempts;){var i=(r=0===r.length?[...p].filter(t=>!e.some(e=>e.word===t.word)):r)[0];I(i,d)?(e.push(i),C.add(i.word),r.shift()):(r.shift(),t++)}if((p=e).length<m.wordCount[u]){console.warn(`Only placed ${p.length} out of ${m.wordCount[u]} words`);var s=m.wordCount[u]-p.length,c=(await A(m,s)).filter(e=>!C.has(e.word));let e=0;for(;p.length<m.wordCount[u]&&e<m.maxTotalAttempts&&0<c.length;){var h=c[0];I(h,d)?(p.push(h),C.add(h.word),c.shift(),console.log(`Simpler placement: Placed word: ${h.word}, Total placed: `+p.length)):(c.shift(),e++,console.log("Simpler placement failed for: "+h.word))}}p.length===m.wordCount[u]?o=!0:(console.warn("Failed to place all words on attempt "+l),C.clear(),(p=await A(m)).sort((e,t)=>t.letters.length-e.letters.length),y={horizontal:0,vertical:0,diagonal:0})}if(!o)throw new Error(`Could only place ${p.length} out of ${m.wordCount[u]} words after 3 attempts`);{let r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";w.forEach((e,t)=>{""===e.letter&&(e.letter=r[Math.floor(Math.random()*r.length)])}),console.log("Grid after filling empty cells:",w)}L.style.setProperty("--cols",m.gridCols),L.style.setProperty("--rows",m.gridRows),L.style.display="grid",L.style.width="100%",L.style.maxWidth="100%",L.style.overflow="hidden",L.innerHTML="",w.forEach((e,t)=>{var r=document.createElement("div");r.className="wordsearch-cell",r.textContent=e.letter,r.dataset.index=t,r.addEventListener("mousedown",b),r.addEventListener("mouseenter",e=>{e.preventDefault(),U(e)}),r.addEventListener("mouseup",B),r.addEventListener("touchstart",P,{passive:!1}),r.addEventListener("touchmove",W,{passive:!1}),r.addEventListener("touchend",G),L.appendChild(r),e.element=r}),T.innerHTML="",p.forEach(e=>{var t=document.createElement("div");t.className="wordsearch-word",t.textContent=e.word,t.dataset.word=e.word,T.appendChild(t)}),O(),N(),D(`Find ${p.length} hidden words!`,"info"),t=0}catch(e){if(console.error("Game initialization failed:",e),D("Failed to load puzzle. Retrying...","error"),++t>=m.maxRetries)return void D("Failed to load puzzle after multiple attempts. Please refresh the page.","error");setTimeout(()=>{var e=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=m.minWordLength&&e.length<=m.maxWordLength),e=[...new Set(e)].filter(e=>!C.has(e));(p=x(e).slice(0,m.wordCount[u]).map(e=>({word:e,letters:e.split("")}))).sort((e,t)=>t.letters.length-e.letters.length),R()},2e3)}"undefined"!=typeof gtag&&gtag("event","word_search_started",{event_category:"word_search",event_label:1,value:void 0})}async function A({minWordLength:o,maxWordLength:l,wordCount:n},a=null){try{var d=Math.floor(9e5*Math.random()),i=a||3*n[u],e=await db.collection("dictionary").where("length",">=",o).where("length","<=",l).where("randomIndex",">=",d).orderBy("randomIndex").limit(i).get();if(e.empty)throw new Error("No words found in dictionary");let t=new Set,r=[];if(e.forEach(e=>{var e=e.data();e.word&&e.letters&&(e=e.word.toUpperCase(),C.has(e)||(t.add(e),r.push({word:e,letters:e.split("").map(e=>e.toUpperCase())})))}),0===t.size)throw new Error("No valid words found");return x(r).slice(0,a||n[u])}catch(e){console.error("Error fetching words:",e);d=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=o&&e.length<=l),i=x([...new Set(d)].filter(e=>!C.has(e))).slice(0,a||n[u]).map(e=>({word:e,letters:e.split("")}));return console.log("Fallback word list:",i),i}}function I(t,r){var o,e=[{id:0,type:"horizontal",rowStep:0,colStep:1},{id:1,type:"vertical",rowStep:1,colStep:0},{id:2,type:"diagonal",rowStep:1,colStep:1},{id:3,type:"diagonal",rowStep:-1,colStep:1}],l=e.filter(e=>!("horizontal"===e.type&&y.horizontal>=r.horizontal||"vertical"===e.type&&y.vertical>=r.vertical||"diagonal"===e.type&&y.diagonal>=r.diagonal));for(o of x([...0<l.length?l:e]))for(let e=0;e<50;e++){var n=0===o.rowStep?m.gridRows:m.gridRows-t.letters.length*Math.abs(o.rowStep),a=0===o.colStep?m.gridCols:m.gridCols-t.letters.length*Math.abs(o.colStep),n=Math.floor(Math.random()*n),a=Math.floor(Math.random()*a);if(((e,o,l,n)=>{var a=e.letters;for(let r=0;r<a.length;r++){let e=o,t=l;switch(n){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}if(e<0||e>=m.gridRows||t<0||t>=m.gridCols)return;var d=e*m.gridCols+t;if(""!==w[d].letter&&w[d].letter!==a[r])return}return 1})(t,n,a,o.id)){g=u=h=c=s=i=d=void 0;var d=t,i=n,s=a,c=o.id,{word:h,letters:u}=d;for(let r=0;r<u.length;r++){let e=i,t=s;switch(c){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}var g=e*m.gridCols+t;w[g].letter=u[r],w[g].word=h}return"horizontal"===o.type?y.horizontal++:"vertical"===o.type?y.vertical++:"diagonal"===o.type&&y.diagonal++,1}}}function d(){if(!(E.length<m.minWordLength)){var e=E.map(e=>w[e].letter).join(""),l=e.split("").reverse().join("");let t=e.toUpperCase(),r=l.toUpperCase(),o=p.find(e=>e.word.toUpperCase()===t||e.word.toUpperCase()===r);o&&!v.includes(o.word)?(v.push(o.word),E.forEach(e=>{w[e].element.classList.remove("selected"),w[e].element.classList.add("found")}),T.querySelectorAll(".wordsearch-word").forEach(e=>{e.dataset.word===o.word&&e.classList.add("found")}),O(),D("Found: "+o.word,"success"),v.length===p.length&&(3<=++g?("easy"===u?(u="medium",D("Advanced to Medium level!","success")):"medium"===u?(u="hard",D("Advanced to Hard level!","success")):D("Mastered all levels!","success"),g=0,f++):D(`Great job! ${3-g} more wins to advance.`,"info"),e={difficulty:u,consecutiveWins:g,currentLevel:f},localStorage.setItem("wordGameState",JSON.stringify(e)),N(),setTimeout(()=>{R()},2e3))):D("Word not found in list","error")}E=[],s()}function N(){var e;console.log(f+" "+u),S?S.textContent=`Level: ${f} (${u})`:console.error("level Element not found"),"hard"!==u?(e=3-g,M.textContent=0<e?"Wins to next level: "+e:"Ready to advance!"):M.textContent="Max level reached!"}function O(){r.textContent=`Words: ${p.length-v.length}/`+p.length}function D(e,t){l.textContent=e,l.className="word-feedback "+t}function x(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}function b(e){e.preventDefault(),o=!0;e=i(e.target);null!==e&&(E=[e],s())}function U(e){var t,r;e.preventDefault(),!o||0===E.length||null===(e=i(e.target))||E.includes(e)||(t=E[E.length-1],r=(()=>{if(!(E.length<2)){var e=E[0],t=E[1],r=Math.floor(e/m.gridCols),e=e%m.gridCols,o=Math.floor(t/m.gridCols),t=t%m.gridCols,o=o-r,r=t-e;if(0==o&&0!=r)return{row:0,col:0<r?1:-1};if(0==r&&0!=o)return{row:0<o?1:-1,col:0};if(Math.abs(o)===Math.abs(r))return{row:0<o?1:-1,col:0<r?1:-1}}return null})(),1<E.length&&!((e,t,r)=>{var o,l;if(r)return l=Math.floor(e/m.gridCols),e%=m.gridCols,o=Math.floor(t/m.gridCols),t%=m.gridCols,o-=l,l=t-e,0===r.row?0==o&&l===r.col:0===r.col?0==l&&o===r.row:Math.sign(o)===Math.sign(r.row)&&Math.sign(l)===Math.sign(r.col)&&Math.abs(o)===Math.abs(l)})(t,e,r))||(E.push(e),s())}function B(){o&&(o=!1,d())}function i(e){return e.classList.contains("wordsearch-cell")?parseInt(e.dataset.index):null}function s(){w.forEach(e=>{e.element.classList.remove("selected")}),E.forEach(e=>{w[e].element.classList.add("selected")})}function P(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&b({target:e,preventDefault:()=>{}})}function W(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&U({target:e,preventDefault:()=>{}})}function G(e){e.preventDefault(),B()}a&&(a.appendChild(S),a.appendChild(M)),N(),R(),e.addEventListener("click",R),n.addEventListener("click",function(){var e=p.filter(e=>!v.includes(e.word));0<e.length?D(`Try looking for a word starting with ${e[Math.floor(Math.random()*e.length)].word.slice(0,2)}...`,"info"):D("You found all words!","success")})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
