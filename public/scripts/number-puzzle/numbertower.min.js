function initPuzzle(){let m={level:1,score:0,timeLeft:180,currentNumbers:[],gameActive:!1,currentRule:"",targetHeight:5,currentHeight:0,lastNumber:null,isMuted:JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,timerInterval:null,difficulty:"medium"},r={select:new Audio("/audio/click.mp3"),correct:new Audio("/audio/correct.mp3"),win:new Audio("/audio/win.mp3"),error:new Audio("/audio/wrong.mp3")},g={towerGrid:document.getElementById("tower-grid"),towerStack:document.getElementById("tower-stack"),towerFeedback:document.getElementById("tower-feedback"),towerHint:document.getElementById("tower-hint"),towerClear:document.getElementById("tower-clear"),towerNew:document.getElementById("tower-new"),towerLevel:document.getElementById("tower-level"),towerScore:document.getElementById("tower-score"),towerTime:document.getElementById("tower-time"),towerHeight:document.getElementById("tower-height"),towerTarget:document.getElementById("tower-target"),towerObjective:document.getElementById("tower-objective"),progressFill:document.getElementById("progress-fill"),towerDifficulty:document.getElementById("tower-difficulty")};function d(t){m.isMuted?console.log(`Sound ${t} skipped: muted`):r[t]&&(r[t].currentTime=0,r[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e)))}function t(){Object.keys(r).forEach(e=>{e=e,r[e]&&(r[e].pause(),r[e].currentTime=0)})}function n(){clearInterval(m.timerInterval),m.level=1,m.score=0,m.timeLeft=180,m.currentHeight=0,m.isMuted=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,m.difficulty=localStorage.getItem("towerDifficulty")||"medium",l(m.difficulty),b(),f(),h(),w(),m.gameActive=!0,"undefined"!=typeof gtag&&gtag("event","numbertower_started",{event_category:"number_tower",event_label:1,value:void 0}),m.isMuted&&t();var e=document.querySelector("#mute-btn .material-icons");e&&(e.textContent=m.isMuted?"volume_off":"volume_up"),d("select")}function l(e){switch(m.difficulty=e,localStorage.setItem("towerDifficulty",e),e){case"easy":m.targetHeight=3;break;case"medium":m.targetHeight=5;break;case"hard":m.targetHeight=8}g.towerTarget.textContent=m.targetHeight,b()}function f(){var e,t=[{name:"multiples",text:"Build the tower by selecting multiples of X!",fn:(e,t)=>e%t==0,minX:2,xGenerator:e=>Math.max(2,Math.floor(e/2)+1),numberGenerator:(t,r)=>{var n=[];for(let e=t;e<=r;e+=t)n.push(e);return{numbers:n,x:t}}},{name:"factors",text:"Build the tower by selecting factors of X!",fn:(e,t)=>t%e==0,minX:4,xGenerator:e=>{var t=[4,6,8,9,10,12,14,15,16,18,20];return t[Math.floor(Math.random()*t.length)]},numberGenerator:(t,e)=>{var r=[];for(let e=1;e<=t;e++)t%e==0&&r.push(e);return{numbers:r,x:t}}},{name:"greater",text:"Build the tower by selecting numbers greater than X!",fn:(e,t)=>t<e,minX:1,xGenerator:(e,t)=>Math.max(1,Math.floor(.3*t)),numberGenerator:(r,e)=>({numbers:Array.from({length:e-r},(e,t)=>r+1+t),x:r})},{name:"less",text:"Build the tower by selecting numbers less than X!",fn:(e,t)=>e<t,minX:4,xGenerator:(e,t)=>Math.min(t-2,Math.max(4,Math.floor(.7*t))),numberGenerator:(e,t)=>({numbers:Array.from({length:e-1},(e,t)=>t+1),x:e})},{name:"additive",text:"Build the tower by selecting numbers that are X more than the last!",fn:(e,t,r)=>!r||e===r+t,xGenerator:e=>Math.max(1,Math.floor(e/3)+1),numberGenerator:(e,t)=>({numbers:Array.from({length:t},(e,t)=>t+1),x:e})},{name:"multiplicative",text:"Build the tower by selecting numbers that are X times the last!",fn:(e,t,r)=>!r||e===r*t,xGenerator:e=>Math.max(2,Math.floor(e/3)+2),numberGenerator:(e,t)=>({numbers:Array.from({length:t},(e,t)=>t+1),x:e})}],r=v();let n,l;for(let e=0;e<3;e++){var o=(n=t[Math.floor(Math.random()*t.length)]).xGenerator(m.level,r);if((l=n.numberGenerator(o,r)).numbers.length>=m.targetHeight)break}l.numbers.length<m.targetHeight&&(e=(n=t.find(e=>"multiples"===e.name)).xGenerator(m.level),l=n.numberGenerator(e,r)),m.currentRule={text:n.text.replace("X",l.x),fn:(e,t)=>n.fn(e,l.x,t),xValue:l.x,numbers:l.numbers},g.towerTarget.textContent=m.targetHeight,g.towerHeight.textContent=m.currentHeight,g.towerObjective.textContent=m.currentRule.text}function h(){g.towerGrid.innerHTML="",g.towerStack.innerHTML="",m.currentNumbers=[],m.lastNumber=null;var e=m.level<=3?6:m.level<=6?8:10,t=e*e,r=v();let n=[],l=[];var o=m.currentRule,a=o.xValue;if(o.text.includes("multiples of")){let e=a;for(;e<=r&&l.length<m.targetHeight;)l.push(e),e+=a;if(l.length<m.targetHeight)for(l=[],e=a;e<=r&&l.length<m.targetHeight;)l.push(e),e+=a}else if(o.text.includes("factors of")){for(let e=1;e<=a;e++)a%e==0&&l.length<m.targetHeight&&l.push(e);for(;l.length<m.targetHeight&&0<l.length;)l.push(2*l[l.length-1])}else if(o.text.includes("greater than")){let e=a+1;for(;e<=r&&l.length<m.targetHeight;)l.push(e),e++}else if(o.text.includes("less than")){let e=1;for(;e<a&&l.length<m.targetHeight;)l.push(e),e++}else if(o.text.includes("more than the last")){let e=1;for(;e<=r&&l.length<m.targetHeight;)l.push(e),e+=a;if(l.length<m.targetHeight)for(l=[],e=1;e<=r&&l.length<m.targetHeight;)l.push(e),e+=a}else if(o.text.includes("times the last")){let e=r;for(l=[];1<=e&&l.length<m.targetHeight;)e%a==0||0===l.length?(l.unshift(e),e/=a):e--;if(l.reverse(),l.length<m.targetHeight)for(e=1,l=[e];e<=r&&l.length<m.targetHeight;)(e*=a)<=r&&l.push(e)}n=[...l];for(var i=Math.max(m.targetHeight+2,Math.ceil(.4*t));n.length<i;){var c=m.currentRule.numbers.filter(e=>!n.includes(e)&&(0===m.currentHeight||m.currentRule.fn(e,m.lastNumber)));if(!(0<c.length))break;n.push(c[Math.floor(Math.random()*c.length)])}for(;n.length<t;){var s=Math.floor(Math.random()*r)+1;n.push(s)}n=(e=>{var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t})(n);for(let e=0;e<t;e++){var u=n[e];m.currentNumbers.push(u);let l=document.createElement("div");l.className="tower-cell",l.textContent=u,l.dataset.number=u,l.addEventListener("click",()=>{var e=l;if(m.gameActive&&(r=parseInt(e.dataset.number),d("select"),!e.classList.contains("selected")))if(t=m.currentRule.fn(r,m.lastNumber),e.classList.add("selected"),t){e.classList.add("correct");var t=r,r=(m.lastNumber=t,m.currentHeight++,g.towerHeight.textContent=m.currentHeight,document.createElement("div"));if(r.className="tower-block",r.textContent=t,g.towerStack.appendChild(r),g.towerStack.style.transform=`translateY(${-10*m.currentHeight}px)`,g.towerStack.style.transition="transform 0.3s",m.score+=2*m.level,b(),x(),d("correct"),m.currentHeight>=m.targetHeight){m.gameActive=!1,clearInterval(m.timerInterval),g.towerFeedback.textContent=`Level Complete! +${15*m.level} bonus points!`,g.towerFeedback.className="tower-feedback correct",m.score+=15*m.level,m.level++,b(),d("win");var n={particleCount:250,spread:80};if(console.log("Triggering confetti"),"undefined"==typeof confetti)console.error("Confetti library not loaded");else{let e={particleCount:100,spread:70,origin:{y:.6},colors:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]};confetti({...e,...n}),.5<Math.random()&&setTimeout(()=>{confetti({...e,...n,angle:180*Math.random()-90,origin:{x:Math.random(),y:.6}})},300)}setTimeout(()=>{m.timeLeft=180,m.currentHeight=0,m.gameActive=!0,f(),h(),w()},2e3)}}else e.classList.add("wrong"),m.timeLeft=Math.max(5,m.timeLeft-3),b(),d("error")}),g.towerGrid.appendChild(l)}g.towerGrid.style.gridTemplateColumns=`repeat(${e}, 1fr)`}function v(){return m.level<=2?20:m.level<=4?100:m.level<=6?500:1e3}function w(){console.log("Starting timer"),clearInterval(m.timerInterval),m.timerInterval=setInterval(()=>{console.log("Timer tick: "+m.timeLeft),m.timeLeft--,b(),m.timeLeft<=10&&g.towerTime.classList.add("time-critical"),m.timeLeft<=0&&(console.log("Timer expired"),clearInterval(m.timerInterval),m.timerInterval=null,m.gameActive=!1,g.towerFeedback.textContent="Game Over! Final Score: "+m.score,g.towerFeedback.className="tower-feedback wrong",d("error"))},1e3)}function o(){if(m.gameActive){d("select");var t=Array.from(document.querySelectorAll(".tower-cell")).filter(e=>!e.classList.contains("selected")&&m.currentRule.fn(parseInt(e.dataset.number),m.lastNumber));if(0<t.length){let e=t[Math.floor(Math.random()*t.length)];e.classList.add("hint"),setTimeout(()=>{e.classList.remove("hint")},1e3)}else g.towerFeedback.textContent="No valid moves left!",g.towerFeedback.className="tower-feedback info"}}function b(){g.towerLevel.textContent="Level: "+m.level,g.towerScore.textContent="Score: "+m.score,g.towerTime.textContent=`Time: ${m.timeLeft}s`,g.towerDifficulty&&(g.towerDifficulty.textContent="Difficulty: "+(m.difficulty.charAt(0).toUpperCase()+m.difficulty.slice(1)))}function x(){var e=m.currentHeight/m.targetHeight*100;g.progressFill.style.width=e+"%"}function a(){var e;m.gameActive&&0!==m.currentHeight&&(d("select"),(e=g.towerStack.lastElementChild)&&g.towerStack.removeChild(e),m.currentHeight--,g.towerHeight.textContent=m.currentHeight,(e=Array.from(document.querySelectorAll(".tower-cell.selected")).pop())&&e.classList.remove("selected","correct","wrong"),0===m.currentHeight?m.lastNumber=null:(e=g.towerStack.lastElementChild,m.lastNumber=e?parseInt(e.textContent):null),g.towerStack.style.transform=`translateY(${-10*m.currentHeight}px)`,x())}n();{g.towerHint.addEventListener("click",o),g.towerNew.addEventListener("click",n),g.towerClear.addEventListener("click",a);var i=document.getElementById("mute-btn");let e=document.querySelector("#mute-btn .material-icons");i&&i.addEventListener("click",()=>{m.isMuted=!m.isMuted,localStorage.setItem("triviaMasterMuteState",m.isMuted),e&&(e.textContent=m.isMuted?"volume_off":"volume_up"),m.isMuted&&t(),d("select")}),["easy","medium","hard"].forEach(e=>{var t=document.getElementById("difficulty-"+e);t&&t.addEventListener("click",()=>{l(e),n(),d("select")})})}}export{initPuzzle};
