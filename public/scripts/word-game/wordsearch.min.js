function initWordGame(){var e=(e=localStorage.getItem("wordGameState"))?JSON.parse(e):null;let u=e?.difficulty||"easy",m=e?.consecutiveWins||0,g=e?.currentLevel||1,f={easy:{gridCols:6,gridRows:8,minWordLength:3,maxWordLength:5,wordCount:6,timeLimit:240},medium:{gridCols:8,gridRows:10,minWordLength:4,maxWordLength:7,wordCount:8,timeLimit:300},hard:{gridCols:10,gridRows:10,minWordLength:5,maxWordLength:8,wordCount:10,timeLimit:500},maxPlacementAttempts:200,maxTotalAttempts:1e3,maxRetries:3},p=[],w=[],v=[],y=[],E=!1,C=new Set,t=0,L={horizontal:0,vertical:0,diagonal:0},r=f[u].timeLimit,M=null,U=document.getElementById("wordsearch-time")||((e=document.createElement("div")).id="wordsearch-time",e.className="word-game-timer",document.querySelector(".word-game-meta").appendChild(e),e),S=document.getElementById("wordsearch-grid"),T=document.getElementById("wordsearch-wordlist"),B=document.getElementById("wordsearch-words-left"),o=document.getElementById("wordsearch-feedback");var e=document.getElementById("wordsearch-new"),P=document.getElementById("wordsearch-hint");let n=document.getElementById("wordsearch-level"),x=document.getElementById("wordsearch-games-remaining"),l=document.querySelector("#mute-btn .material-icons"),a={select:new Audio("/audio/click.mp3"),found:new Audio("/audio/correct.mp3"),win:new Audio("/audio/win.mp3"),error:new Audio("/audio/wrong.mp3")},i=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1;function R(t){i||a[t]&&(a[t].currentTime=0,a[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e)))}function d(){Object.keys(a).forEach(e=>{e=e,a[e]&&(a[e].pause(),a[e].currentTime=0)})}function b(e,t,r,o){"undefined"!=typeof gtag&&gtag("event",e,{event_category:t,event_label:r,value:o})}function I(){var e=Math.floor(r/60),t=r%60;U.textContent=`Time: ${e}:`+t.toString().padStart(2,"0")}function s(){var e={difficulty:u,consecutiveWins:m,currentLevel:g};localStorage.setItem("wordGameState",JSON.stringify(e))}function z(t,r){var o,e=[{id:0,type:"horizontal",rowStep:0,colStep:1},{id:1,type:"vertical",rowStep:1,colStep:0},{id:2,type:"diagonal",rowStep:1,colStep:1},{id:3,type:"diagonal",rowStep:-1,colStep:1}],n=e.filter(e=>!("horizontal"===e.type&&L.horizontal>=r.horizontal||"vertical"===e.type&&L.vertical>=r.vertical||"diagonal"===e.type&&L.diagonal>=r.diagonal));for(o of O([...0<n.length?n:e]))for(let e=0;e<f.maxPlacementAttempts;e++){var l=0===o.rowStep?f[u].gridRows:f[u].gridRows-t.letters.length*Math.abs(o.rowStep),a=0===o.colStep?f[u].gridCols:f[u].gridCols-t.letters.length*Math.abs(o.colStep),l=Math.floor(Math.random()*l),a=Math.floor(Math.random()*a);if(((e,o,n,l)=>{var a=e.letters;for(let r=0;r<a.length;r++){let e=o,t=n;switch(l){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}if(e<0||e>=f[u].gridRows||t<0||t>=f[u].gridCols)return;var i=e*f[u].gridCols+t;if(""!==p[i].letter&&p[i].letter!==a[r])return}return 1})(t,l,a,o.id)){g=m=h=c=s=d=i=void 0;var i=t,d=l,s=a,c=o.id,{word:h,letters:m}=i;for(let r=0;r<m.length;r++){let e=d,t=s;switch(c){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}var g=e*f[u].gridCols+t;p[g].letter=m[r],p[g].word=h}return L[o.type]++,1}}}function G(e){e.preventDefault(),E=!0;e=W(e.target);null!==e&&(y=[e],h(),R("select"))}function H(e){var t,r,o,n,l;e.preventDefault(),!E||0===y.length||null===(e=W(e.target))||y.includes(e)||(n=y[y.length-1],l=f[u].gridCols,y.length<3?(r=Math.floor(n/l),o=n%l,t=Math.floor(e/l),o=e%l-o,Math.abs(t-r)<=1.5&&Math.abs(o)<=1.5&&(y.push(e),h())):(t=c())&&(r=Math.floor(n/l),o=n%l,n=Math.floor(e/l),l=e%l-o,Math.abs(n-r-t.row)<=.5)&&Math.abs(l-t.col)<=.5&&(y.push(e),h()))}function c(){var e,t,r,o;return y.length<2?null:(r=f[u].gridCols,o=y[0],t=y[y.length-1],e=Math.floor(o/r),o=o%r,e=Math.floor(t/r)-e,t=t%r-o,r=Math.atan2(e,t),(o=Math.abs(r*(180/Math.PI)))<22.5||157.5<o?{row:0,col:Math.sign(t),type:"horizontal"}:67.5<o&&o<112.5?{row:Math.sign(e),col:0,type:"vertical"}:{row:Math.sign(e),col:Math.sign(t),type:"diagonal"})}function $(){if(E){if(E=!1,3<=y.length){var t=c();if(t&&"diagonal"===t.type){var r=f[u].gridCols,e=y[0],o=(Math.floor(e/r),[e]);for(let e=1;e<y.length;e++){var n=o[o.length-1],l=Math.floor(n/r)+t.row,n=n%r+t.col;if(!(0<=l&&l<f[u].gridRows&&0<=n&&n<f[u].gridCols))break;o.push(l*r+n)}y=o,h()}}if(y.length<f[u].minWordLength)R("error");else{var e=y.map(e=>p[e].letter).join(""),a=e.split("").reverse().join("");let t=e.toUpperCase(),n=a.toUpperCase(),l=w.find(e=>e.word.toUpperCase()===t||e.word.toUpperCase()===n);if(l&&!v.includes(l.word)){v.push(l.word),R("found");let r=v.length%4,o=["rgba(122, 255, 195, 0.7)","rgba(142, 196, 250, 0.7)","rgba(255, 216, 117, 0.7)","rgba(255, 158, 232, 0.7)"];(l.word.toUpperCase()===n?y.reverse():y).forEach((e,t)=>{t<l.letters.length&&p[e].letter===l.letters[t]&&((t=p[e].element.style.backgroundColor)&&"transparent"!==t?(p[e].element.style.backgroundColor=o[r],p[e].element.style.boxShadow="inset 0 0 0 2px "+t):p[e].element.style.backgroundColor=o[r],p[e].element.classList.add("found"))});e=T.querySelector(`[data-word="${l.word}"]`);e&&e.remove(),_(),N("Found: "+l.word,"success"),v.length===w.length&&(()=>{R("win");let e=document.createElement("div"),t=(e.className="victory-screen",F(),m++,g++,""),r=!1,o=(3<=m?(t="easy"===u?(u="medium",r=!0,"🎉 Advanced to Medium level! 🎉"):"medium"===u?(u="hard",r=!0,"🏆 Advanced to Hard level! 🏆"):"👑 Mastered Hard level! Continuing at max difficulty. 👑",r&&(m=0,setTimeout(()=>F({particleCount:200,spread:100}),1e3))):t=`🎊 Level ${g} Complete! 🎊`,e.innerHTML=`
      <h2>Victory!</h2>
      <p>${t}</p>
      <p>Words Found: ${v.length}</p>
      <div class="countdown">Proceeding to the next level in 5...</div>
    `,document.body.appendChild(e),5),n=e.querySelector(".countdown"),l=setInterval(()=>{o--,n.textContent=`Proceeding to the next level in ${o}...`,o<=0&&(clearInterval(l),e.remove(),s(),A(),D())},1e3);b("level_complete","word_search",u,v.length),s(),A()})()}else R("error"),N("Word not found in list","error")}y=[],h()}}function h(){if(p.forEach(e=>{e.element.classList.remove("selected"),e.element.classList.remove("direction-locked"),e.element.classList.remove("diagonal-hint")}),y.forEach(e=>{p[e].element.classList.add("selected")}),2<=y.length){let t=c();var e,r,o;t&&(y.forEach(e=>{p[e].element.classList.add("direction-locked"),"diagonal"===t.type&&p[e].element.classList.add("diagonal-hint")}),"diagonal"===t.type)&&1<y.length&&(e=f[u].gridCols,r=y[y.length-1],o=Math.floor(r/e)+t.row,r=r%e+t.col,0<=o)&&o<f[u].gridRows&&0<=r&&r<f[u].gridCols&&(o=o*e+r,p[o].element.classList.add("diagonal-hint"))}}function F(e={}){let t={particleCount:100,spread:70,origin:{y:.6},colors:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]};confetti({...t,...e}),.5<Math.random()&&setTimeout(()=>{confetti({...t,...e,angle:180*Math.random()-90,origin:{x:Math.random(),y:.6}})},300)}function A(){var e;n&&(n.textContent=`Level: ${g} (${u})`),"hard"!==u?(e=3-m,x.textContent=0<e?"Wins to next difficulty: "+e:"Ready to advance difficulty!"):x.textContent="Max difficulty reached!"}function _(){B.textContent=`Words: ${w.length-v.length}/`+w.length}function N(e,t){o.textContent=e,o.className="word-feedback "+t}function O(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}function G(e){e.preventDefault(),E=!0;e=W(e.target);null!==e&&(y=[e],h(),R("select"))}function W(e){return e.classList.contains("wordsearch-cell")?parseInt(e.dataset.index):null}function h(){p.forEach(e=>{e.element.classList.remove("selected"),e.element.classList.remove("direction-locked")}),y.forEach(e=>{p[e].element.classList.add("selected")}),2<=y.length&&y.forEach(e=>{p[e].element.classList.add("direction-locked")})}function V(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&G({target:e,preventDefault:()=>{}})}function Y(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&H({target:e,preventDefault:()=>{}})}function J(e){e.preventDefault(),$()}function q(){var e=document.querySelector(".word-game-card");e&&(window.innerWidth<=768?(e.style.width="100%",e.style.margin="0",e.style.padding="1rem",e.style.minHeight="calc(100vh - 80px)",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center"):(e.style.width="600px",e.style.margin="2rem auto",e.style.padding="2rem",e.style.minHeight="auto",e.style.display="block")),X()}function X(){var e=T.parentElement;window.innerWidth<=768?(T.style.width="100%",T.style.maxWidth="100%",T.style.overflowX="auto",T.style.whiteSpace="nowrap",T.style.marginTop="1rem",T.style.padding="0.5rem",T.style.display="flex",T.style.flexWrap="wrap",T.style.justifyContent="center",T.querySelectorAll(".wordsearch-word").forEach(e=>{e.style.display="inline-block",e.style.margin="0.25rem 0.5rem",e.style.fontSize="14px"}),e&&(e.style.display="block",e.style.width="100%",e.style.overflow="visible")):(T.style.width="auto",T.style.maxWidth="none",T.style.overflowX="visible",T.style.whiteSpace="normal",T.style.marginTop="0",T.style.padding="0",T.style.display="grid",T.style.gridTemplateColumns="repeat(2, 1fr)",T.style.gap="0.5rem",T.querySelectorAll(".wordsearch-word").forEach(e=>{e.style.display="block",e.style.margin="0.5rem 0",e.style.fontSize="16px"}),e&&(e.style.display="block",e.style.width="auto",e.style.overflow="visible"))}async function k(o,n=null){try{var l=Math.floor(9e5*Math.random()),e=n||o.wordCount,a=await db.collection("dictionary").where("length",">=",o.minWordLength).where("length","<=",o.maxWordLength).where("randomIndex",">=",l).orderBy("randomIndex").limit(e).get();if(a.empty)throw new Error("No words found in dictionary");let t=new Set,r=[];if(a.forEach(e=>{var e=e.data();e.word&&e.letters&&(e=e.word.toUpperCase(),C.has(e)||(t.add(e),r.push({word:e,letters:e.split("").map(e=>e.toUpperCase())})))}),0===t.size)throw new Error("No valid words found");return O(r).slice(0,n||o.wordCount)}catch(e){console.error("Error fetching words:",e);l=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=o.minWordLength&&e.length<=o.maxWordLength);return O([...new Set(l)].filter(e=>!C.has(e))).slice(0,n||o.wordCount).map(e=>({word:e,letters:e.split("")}))}}async function D(){console.log("Initializing game with state:",{difficulty:u,currentLevel:g,consecutiveWins:m}),o.innerHTML=`
      <div class="loading-animation">
        <div class="loading-spinner"></div>
        <div class="loading-text">Creating your puzzle</div>
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    `,o.className="word-feedback info",N("","info"),S.innerHTML="",T.innerHTML="",y=[],v=[],E=!1,C.clear(),L={horizontal:0,vertical:0,diagonal:0};var e=document.querySelector(".word-game-meta");e&&!document.getElementById("wordsearch-level")&&(e.appendChild(n),e.appendChild(x)),A();try{(w=await k(f[u])).sort((e,t)=>t.letters.length-e.letters.length),console.log("Words fetched and sorted:",w);let o=!1,n=0;for(;!o&&n<3;){n++,console.log(`Attempt ${n} to place all words`),p=Array(f[u].gridCols*f[u].gridRows).fill().map(()=>({letter:"",element:null,word:null}));let e=[],t=0,r=[...w];for(var l=f[u].wordCount,a=Math.floor(l/3),i={horizontal:a,vertical:a,diagonal:l-2*a};e.length<f[u].wordCount&&t<f.maxTotalAttempts;){var d=(r=0===r.length?[...w].filter(t=>!e.some(e=>e.word===t.word)):r)[0];z(d,i)?(e.push(d),C.add(d.word),r.shift()):(r.shift(),t++)}if((w=e).length<f[u].wordCount){console.warn(`Only placed ${w.length} out of ${f[u].wordCount} words`);var s=f[u].wordCount-w.length,c=(await k(f[u],s)).filter(e=>!C.has(e.word));let e=0;for(;w.length<f[u].wordCount&&e<f.maxTotalAttempts&&0<c.length;){var h=c[0];z(h,i)?(w.push(h),C.add(h.word),c.shift()):(c.shift(),e++)}}w.length===f[u].wordCount?o=!0:(console.warn("Failed to place all words on attempt "+n),C.clear(),(w=await k(f[u])).sort((e,t)=>t.letters.length-e.letters.length),L={horizontal:0,vertical:0,diagonal:0})}if(!o)throw new Error(`Could only place ${w.length} out of ${f[u].wordCount} words after 3 attempts`);{let r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";p.forEach((e,t)=>{""===e.letter&&(e.letter=r[Math.floor(Math.random()*r.length)])})}{S.style.setProperty("--cols",f[u].gridCols),S.style.setProperty("--rows",f[u].gridRows),S.style.display="grid";let e=Math.min(window.innerWidth,600),t=e/f[u].gridCols,o=Math.min(t,50),r=o*f[u].gridCols,n=o*f[u].gridRows;S.style.width=r+"px",S.style.height=n+"px",S.style.maxWidth="100%",S.style.overflow="hidden",S.innerHTML="",p.forEach((e,t)=>{var r=document.createElement("div");r.className="wordsearch-cell",r.textContent=e.letter,r.dataset.index=t,r.style.width=o+"px",r.style.height=o+"px",r.style.fontSize=Math.min(.6*o,16)+"px",r.style.borderRadius="0",r.addEventListener("mousedown",G),r.addEventListener("mouseenter",e=>{e.preventDefault(),H(e),R("select")}),r.addEventListener("mouseup",$),r.addEventListener("touchstart",V,{passive:!1}),r.addEventListener("touchmove",Y,{passive:!1}),r.addEventListener("touchend",J),S.appendChild(r),e.element=r})}T.innerHTML="",[...w].sort((e,t)=>e.word.localeCompare(t.word)).forEach(e=>{var t=document.createElement("div");t.className="wordsearch-word",t.textContent=e.word,t.dataset.word=e.word,T.appendChild(t)}),X(),_(),A(),N(`Find ${w.length} hidden words!`,"info"),clearInterval(M),r=f[u].timeLimit,I(),M=setInterval(()=>{r--,I(),r<=0&&(clearInterval(M),N("Time's up!","error"),setTimeout(D,2e3))},1e3),t=0}catch(e){if(console.error("Game initialization failed:",e),o.innerHTML=`
      <div class="error-animation">
        <div class="error-icon">⚠️</div>
        <div class="loading-text">Setting up the board</div>
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    `,o.className="word-feedback error",++t>=f.maxRetries)return o.innerHTML=`
      <div class="error-animation">
        <div class="error-icon">❌</div>
        <div>Having trouble loading</div>
        <button class="btn primary" onclick="initWordGame()">Try Again</button>
      </div>
    `,void(o.className="word-feedback error");setTimeout(()=>{var e=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=f[u].minWordLength&&e.length<=f[u].maxWordLength),e=[...new Set(e)].filter(e=>!C.has(e));(w=O(e).slice(0,f[u].wordCount).map(e=>({word:e,letters:e.split("")}))).sort((e,t)=>t.letters.length-e.letters.length),D()},2e3)}b("word_search_started","word_search",1)}D(),i=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,l&&(l.textContent=i?"volume_off":"volume_up"),i&&d(),e.addEventListener("click",D),P.addEventListener("click",function(){var e=w.filter(e=>!v.includes(e.word));0<e.length?N(`Try looking for a word starting with ${e[Math.floor(Math.random()*e.length)].word.slice(0,2)}...`,"info"):N("You found all words!","success")});e=document.getElementById("mute-btn");e&&e.addEventListener("click",()=>{i=!i,localStorage.setItem("triviaMasterMuteState",i),l&&(l.textContent=i?"volume_off":"volume_up"),i&&d()}),window.addEventListener("resize",q),q()}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
