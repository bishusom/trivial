function initPuzzle(){let i={level:1,score:0,timeLeft:180,currentNumbers:[],gameActive:!1,currentRule:"",targetHeight:5,currentHeight:0,lastNumber:null,isMuted:JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,timerInterval:null},r={select:new Audio("/audio/click.mp3"),correct:new Audio("/audio/correct.mp3"),win:new Audio("/audio/win.mp3"),error:new Audio("/audio/wrong.mp3")},c={towerGrid:document.getElementById("tower-grid"),towerStack:document.getElementById("tower-stack"),towerFeedback:document.getElementById("tower-feedback"),towerHint:document.getElementById("tower-hint"),towerClear:document.getElementById("tower-clear"),towerNew:document.getElementById("tower-new"),towerLevel:document.getElementById("tower-level"),towerScore:document.getElementById("tower-score"),towerTime:document.getElementById("tower-time"),towerHeight:document.getElementById("tower-height"),towerTarget:document.getElementById("tower-target"),towerObjective:document.getElementById("tower-objective"),progressFill:document.getElementById("progress-fill")};function m(t){i.isMuted?console.log(`Sound ${t} skipped: muted`):r[t]&&(r[t].currentTime=0,r[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e)))}function t(){Object.keys(r).forEach(e=>{e=e,r[e]&&(r[e].pause(),r[e].currentTime=0)})}function n(){clearInterval(i.timerInterval),i.level=1,i.score=0,i.timeLeft=180,i.currentHeight=0,i.isMuted=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,h(),s(),u(),g(),i.gameActive=!0,"undefined"!=typeof gtag&&gtag("event","numbertower_started",{event_category:"number_tower",event_label:1,value:void 0}),i.isMuted&&t();var e=document.querySelector("#mute-btn .material-icons");e&&(e.textContent=i.isMuted?"volume_off":"volume_up"),m("select")}function s(){var e,t=[{name:"multiples",text:"Build the tower by selecting multiples of X!",fn:(e,t)=>e%t==0,minX:2,xGenerator:e=>Math.max(2,Math.floor(e/2)+1),numberGenerator:(t,r)=>{var n=[];for(let e=t;e<=r;e+=t)n.push(e);return{numbers:n,x:t}}},{name:"factors",text:"Build the tower by selecting factors of X!",fn:(e,t)=>t%e==0,minX:4,xGenerator:e=>{var t=[4,6,8,9,10,12,14,15,16,18,20];return t[Math.floor(Math.random()*t.length)]},numberGenerator:(t,e)=>{var r=[];for(let e=1;e<=t;e++)t%e==0&&r.push(e);return{numbers:r,x:t}}},{name:"greater",text:"Build the tower by selecting numbers greater than X!",fn:(e,t)=>t<e,minX:1,xGenerator:(e,t)=>Math.max(1,Math.floor(.3*t)),numberGenerator:(r,e)=>({numbers:Array.from({length:e-r},(e,t)=>r+1+t),x:r})},{name:"less",text:"Build the tower by selecting numbers less than X!",fn:(e,t)=>e<t,minX:4,xGenerator:(e,t)=>Math.min(t-2,Math.max(4,Math.floor(.7*t))),numberGenerator:(e,t)=>({numbers:Array.from({length:e-1},(e,t)=>t+1),x:e})},{name:"additive",text:"Build the tower by selecting numbers that are X more than the last!",fn:(e,t,r)=>!r||e===r+t,xGenerator:e=>Math.max(1,Math.floor(e/3)+1),numberGenerator:(e,t)=>({numbers:Array.from({length:t},(e,t)=>t+1),x:e})},{name:"multiplicative",text:"Build the tower by selecting numbers that are X times the last!",fn:(e,t,r)=>!r||e===r*t,xGenerator:e=>Math.max(2,Math.floor(e/3)+2),numberGenerator:(e,t)=>({numbers:Array.from({length:t},(e,t)=>t+1),x:e})}],r=f();let n,o;for(let e=0;e<3;e++){var l=(n=t[Math.floor(Math.random()*t.length)]).xGenerator(i.level,r);if(4<=(o=n.numberGenerator(l,r)).numbers.length)break}o.numbers.length<4&&(e=(n=t.find(e=>"multiples"===e.name)).xGenerator(i.level),o=n.numberGenerator(e,r)),i.currentRule={text:n.text.replace("X",o.x),fn:(e,t)=>n.fn(e,o.x,t),xValue:o.x,numbers:o.numbers},i.targetHeight=Math.min(4+i.level,10),c.towerTarget.textContent=i.targetHeight,c.towerHeight.textContent=i.currentHeight,c.towerObjective.textContent=i.currentRule.text}function u(){c.towerGrid.innerHTML="",c.towerStack.innerHTML="",i.currentNumbers=[],i.lastNumber=null;var e=i.level<=3?4:i.level<=6?5:6,t=e*e;let r=[];for(var n=Math.max(4,Math.ceil(.4*t)),o=Math.min(n,i.currentRule.numbers.length);r.length<o;)r=r.concat(d([...i.currentRule.numbers]).slice(0,o-r.length));var l=t-r.length;for(let e=0;e<l;e++)r.push(Math.floor(Math.random()*f())+1);r=d(r);for(let e=0;e<t;e++){var a=r[e];i.currentNumbers.push(a);let o=document.createElement("div");o.className="tower-cell",o.textContent=a,o.dataset.number=a,o.addEventListener("click",()=>{var e=o;if(i.gameActive&&(r=parseInt(e.dataset.number),m("select"),!e.classList.contains("selected")))if(t=i.currentRule.fn(r,i.lastNumber),e.classList.add("selected"),t){e.classList.add("correct");var t=r,r=(i.lastNumber=t,i.currentHeight++,c.towerHeight.textContent=i.currentHeight,document.createElement("div"));if(r.className="tower-block",r.textContent=t,c.towerStack.appendChild(r),c.towerStack.style.transform=`translateY(${-10*i.currentHeight}px)`,c.towerStack.style.transition="transform 0.3s",i.score+=2*i.level,h(),v(),m("correct"),i.currentHeight>=i.targetHeight){i.gameActive=!1,clearInterval(i.timerInterval),c.towerFeedback.textContent=`Level Complete! +${15*i.level} bonus points!`,c.towerFeedback.className="tower-feedback correct",i.score+=15*i.level,i.level++,h(),m("win");var n={particleCount:250,spread:80};if(console.log("Triggering confetti"),"undefined"==typeof confetti)console.error("Confetti library not loaded");else{let e={particleCount:100,spread:70,origin:{y:.6},colors:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]};confetti({...e,...n}),.5<Math.random()&&setTimeout(()=>{confetti({...e,...n,angle:180*Math.random()-90,origin:{x:Math.random(),y:.6}})},300)}setTimeout(()=>{i.timeLeft=180,i.currentHeight=0,i.gameActive=!0,s(),u(),g()},2e3)}}else e.classList.add("wrong"),i.timeLeft=Math.max(5,i.timeLeft-3),h(),m("error")}),c.towerGrid.appendChild(o)}c.towerGrid.style.gridTemplateColumns=`repeat(${e}, 1fr)`}function d(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}function f(){return i.level<=2?20:i.level<=4?30:i.level<=6?50:75}function g(){console.log("Starting timer"),clearInterval(i.timerInterval),i.timerInterval=setInterval(()=>{console.log("Timer tick: "+i.timeLeft),i.timeLeft--,h(),i.timeLeft<=10&&c.towerTime.classList.add("time-critical"),i.timeLeft<=0&&(console.log("Timer expired"),clearInterval(i.timerInterval),i.timerInterval=null,i.gameActive=!1,c.towerFeedback.textContent="Game Over! Final Score: "+i.score,c.towerFeedback.className="tower-feedback wrong",m("error"))},1e3)}function o(){if(i.gameActive){m("select");var t=Array.from(document.querySelectorAll(".tower-cell")).filter(e=>!e.classList.contains("selected")&&i.currentRule.fn(parseInt(e.dataset.number),i.lastNumber));if(0<t.length){let e=t[Math.floor(Math.random()*t.length)];e.classList.add("hint"),setTimeout(()=>{e.classList.remove("hint")},1e3)}else c.towerFeedback.textContent="No valid moves left!",c.towerFeedback.className="tower-feedback info"}}function h(){c.towerLevel.textContent="Level: "+i.level,c.towerScore.textContent="Score: "+i.score,c.towerTime.textContent=`Time: ${i.timeLeft}s`}function v(){var e=i.currentHeight/i.targetHeight*100;c.progressFill.style.width=e+"%"}function l(){var e;i.gameActive&&0!==i.currentHeight&&(m("select"),(e=c.towerStack.lastElementChild)&&c.towerStack.removeChild(e),i.currentHeight--,c.towerHeight.textContent=i.currentHeight,(e=Array.from(document.querySelectorAll(".tower-cell.selected")).pop())&&e.classList.remove("selected","correct","wrong"),0===i.currentHeight?i.lastNumber=null:(e=c.towerStack.lastElementChild,i.lastNumber=e?parseInt(e.textContent):null),c.towerStack.style.transform=`translateY(${-10*i.currentHeight}px)`,v())}n();{c.towerHint.addEventListener("click",o),c.towerNew.addEventListener("click",n),c.towerClear.addEventListener("click",l);var a=document.getElementById("mute-btn");let e=document.querySelector("#mute-btn .material-icons");a&&a.addEventListener("click",()=>{i.isMuted=!i.isMuted,localStorage.setItem("triviaMasterMuteState",i.isMuted),e&&(e.textContent=i.isMuted?"volume_off":"volume_up"),i.isMuted&&t(),m("select")})}}export{initPuzzle};
