let messages={gold:["🏆 Trivia Deity! The knowledge gods bow before you! Can you maintain your reign?","🧠 Mind = Blown! Think you can top this perfect score? Try again!","🤯 Unstoppable Genius! Ready for an even bigger challenge next round?","🎖️ Absolute Legend! The leaderboard needs your name again!"],silver:["✨ Brainiac Alert! One more round could push you to perfection!","🚀 Knowledge Rocket! You're just one launch away from trivia greatness!","💎 Diamond Mind! Polish your skills further with another game!","🧩 Puzzle Master! Can you complete the picture perfectly next time?"],bronze:["👍 Solid Effort! Your next attempt could be your breakthrough!","📚 Bookworm Rising! Every replay makes you wiser - try again!","💡 Bright Spark! Your knowledge is growing - fuel it with another round!","🏅 Contender Status! The podium is within reach - one more try!"],zero:["💥 Knowledge Explosion Incoming! Stick around - the next attempt will be better!","🎯 Fresh Start! Now that you've warmed up, the real game begins!","🔥 Fueling Curiosity! Your learning journey starts here - play again!","🚀 Launch Pad Ready! First attempts are just practice - try for real now!","🌱 Seeds of Knowledge Planted! Water them with another try!"],default:["🌱 Sprouting Scholar! Every replay makes you stronger - continue your journey!","🦉 Wise Owl in Training! The more you play, the wiser you become!","📖 Chapter 1 Complete! Turn the page to your next knowledge adventure!","🧭 Learning Compass Active! Your next game could be your true north!"]},els={game:()=>document.querySelector(".game-screen"),summary:()=>document.querySelector(".summary-screen"),question:()=>document.getElementById("question"),options:()=>document.getElementById("options"),nextBtn:()=>document.getElementById("next-btn"),score:()=>document.getElementById("score"),questionTimer:()=>document.getElementById("question-timer"),highscores:()=>document.querySelector(".highscores"),highscoresList:()=>document.getElementById("highscores-list"),resultMessage:()=>document.getElementById("result-message"),correctCount:()=>document.getElementById("correct-count"),timeUsed:()=>document.getElementById("time-used"),questionCounter:()=>document.getElementById("question-counter"),difficultyDisplay:()=>document.getElementById("difficulty-level-display"),difficultyBox:()=>document.querySelector(".difficulty-box")},timers={quick:10,long:60},audio={tick:document.getElementById("tick-sound"),correct:document.getElementById("correct-sound"),wrong:document.getElementById("wrong-sound")},imageCache=(audio.tick.loop=!0,{}),SPECIAL_QUIZ_TYPES=["daily","90s movie trivia","pub quiz","famous quotes","country capitals"],CATEGORY_ALIASES={"board games":"board-games","video games":"video-games","famous quotes":"famous-quotes","country capitals":"country-capitals","90s movie trivia":"90s-movie-trivia","pub quiz":"pub-quiz"},state={isMuted:!1,questions:[],current:0,score:0,timeLeft:null,timerId:null,highScores:[],answers:[],isScoreSaved:!1,isNextPending:!1,selectedQuestions:10,usedQuestions:new Set,fbUsedQuestions:JSON.parse(localStorage.getItem("fbUsedQuestions")||"[]"),fbUsedQuizIds:JSON.parse(localStorage.getItem("fbUsedQuizIds")||"[]"),isTimedMode:!0,timerDuration:"long",difficulty:"mixed",rememberSettings:!1,showSettingsOnStart:!0,category:"general knowledge"},nlp,QUIZ_TYPES=("undefined"!=typeof window&&window.nlp?(nlp=window.nlp,console.log("Found nlp")):(nlp={nouns:()=>({out:()=>[]}),adjectives:()=>({out:()=>[]})},console.log("Creating home-grown nlp")),{DAILY:"daily"}),CACHE={QUESTIONS:"trivia-questions-v1",EXPIRY:864e5};function trackEvent(e,t,s,a){"undefined"!=typeof gtag&&gtag("event",e,{event_category:t,event_label:s,value:a})}function toggleClass(e,t,s){e?.classList?.[t]?.(s)}function playSound(t){state.isMuted?console.log(`Sound ${t} skipped: muted`):(console.log("Playing sound: "+t),audio[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e)))}function stopSound(e){console.log("Stopping sound: "+e),audio[e].pause(),audio[e].currentTime=0}function stopAllSounds(){console.log("Stopping all sounds"),["tick","correct","wrong"].forEach(e=>stopSound(e))}function loadMuteState(){state.isMuted=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1;var e=localStorage.getItem("triviaMasterTimedMode"),e=(state.isTimedMode=null===e||JSON.parse(e),localStorage.getItem("triviaMasterTimerDuration")),e=(state.timerDuration=null!==e?e:"long",localStorage.getItem("triviaMasterDifficulty")),e=(state.difficulty=null!==e?e:"mixed",document.querySelector("#mute-btn .material-icons"));e&&(e.textContent=state.isMuted?"volume_off":"volume_up"),state.isMuted&&stopAllSounds()}function showError(e){let t=document.getElementById("error-message");t||((t=document.createElement("div")).id="error-message",t.className="error-message",t.innerHTML=`<div id="error-text">${e}</div><button id="retry-btn" class="btn small primary">Retry</button>`,els.game().appendChild(t),document.getElementById("retry-btn").addEventListener("click",()=>{initTriviaGame(state.category)})),t.classList.remove("hidden")}async function updatePlayerCount(e){try{var t=db.collection("playerCounts").doc(e),s=await t.get(),a=(s.exists?s.data().count:0)+1;await t.set({count:a,lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),category:e},{merge:!0}),console.log("Updating player count: ",a)}catch(e){return console.error("Error updating player count:",e),Math.floor(40*Math.random())+100}}function extractKeywordNLP(e){var t=nlp(e),s=t.nouns().out("array");return 0<s.length||0<(s=t.adjectives().out("array")).length?s[0]:(t=e.replace(/[^a-zA-Z0-9\s]/g,"").split(" ")).filter(e=>3<e.length&&!["what","which","where","when","who","how"].includes(e.toLowerCase()))[0]||t[0]||"trivia"}async function fetchImage(s){if(s&&"string"==typeof s){if(imageCache[s])return console.log("Using cached image for keyword:",s,imageCache[s]),imageCache[s];console.log("Fetching image for keyword:",s);let t=2;for(;0<t;)try{var e,a=await fetch("/.netlify/functions/get-image?keyword="+encodeURIComponent(s));if(console.log("fetchImage response status:",a.status,"keyword:",s),!a.ok)throw e=await a.text(),console.error("fetchImage HTTP error:",a.status,e),new Error(`HTTP error! status: ${a.status}, message: `+e);var o,i=a.headers.get("content-type");if(i&&i.includes("application/json"))return o=await a.json(),console.log("fetchImage response data:",o),o.url?(imageCache[s]=o.url,o.url):(console.warn("fetchImage: No URL in response for keyword:",s),null);throw console.error("fetchImage invalid content type:",i),new Error("Invalid content type")}catch(e){if(console.error(`fetchImage: Error (attempt ${3-t}) for keyword "${s}":`,e),0===--t)return null;await new Promise(e=>setTimeout(e,1e3))}}else console.warn("Invalid keyword for image fetch:",s);return null}async function preFetchImages(e){e=e.map(e=>e.image_keyword||extractKeywordNLP(e.question)),e=[...new Set(e)];console.log("Pre-fetching images for keywords:",e);try{await Promise.all(e.map(async e=>{var t;imageCache[e]||(t=await fetchImage(e))&&(imageCache[e]=t,console.log("Cached image for",e,":",t))})),console.log("All images pre-fetched:",imageCache)}catch(e){console.error("Error pre-fetching images:",e)}}async function fetchQuestions(e){try{return console.log("Fetching questions for category:",e),SPECIAL_QUIZ_TYPES.includes(e.toLowerCase())?await fetchSpecialQuiz(e.toLowerCase()):await fetchfbQuestions(e,state.selectedQuestions,state.difficulty)}catch(e){throw console.error("Error in fetchQuestions:",e),showError(e.message||"Failed to load questions."),e}}async function fetchSpecialQuiz(e){let t=CATEGORY_ALIASES[e]||e;console.log("Fetching special quiz for:",t);var s=new Date,a=s.toISOString().split("T")[0],a=`fb-${t}-quiz-`+a,o=new Date,i=(o.setHours(24,0,0,0),JSON.parse(localStorage.getItem("fbQuizCache"))?.[a]);return i&&s<o?shuffle(i.questions):(o=await db.collection("triviaMaster").doc("questions").collection("items").where("category","==",t).where("randomIndex",">=",Math.floor(900*Math.random())).orderBy("randomIndex").limit(10).get()).empty?(console.warn(`No questions found for ${e}, falling back to general knowledge`),showError(`No questions available for ${e}. Loading general knowledge instead.`),fetchfbQuestions("general knowledge",10,"mixed")):(i=o.docs.map(e=>({id:e.id,question:decodeHTML(e.data().question),correct:decodeHTML(e.data().correct_answer),options:shuffle([...e.data().incorrect_answers.map(decodeHTML),decodeHTML(e.data().correct_answer)]),category:t,subcategory:e.data().subcategory,difficulty:e.data().difficulty,titbits:e.data().titbits||"",image_keyword:e.data().image_keyword||null})).slice(0,10),localStorage.setItem("fbQuizCache",JSON.stringify({...JSON.parse(localStorage.getItem("fbQuizCache")||"{}"),[a]:{questions:i,timestamp:s.getTime()}})),shuffle(i))}async function fetchfbQuestions(e,s=10,t="mixed"){var a=e.toLowerCase();let o=CATEGORY_ALIASES[e]||e;console.log("Fetching questions for category:",o,"difficulty:",t);var i="mixed"===t?["easy","medium","hard"]:[t],a=`fb_questions-${a}-`+t,r=JSON.parse(localStorage.getItem("fbQuestionsCache"))?.[a];if(r&&r.questions.length>=s&&r.questions.filter(e=>!state.fbUsedQuestions.includes(e.id)).length>=s)return console.log("Using cached questions:",r.questions),processfbQuestions(r.questions,s);var n=[];for(let t of i){let e=db.collection("triviaMaster").doc("questions").collection("items");var c=await(e=(e="general knowledge"!==o?e.where("category","==",o):e).where("randomIndex",">=",Math.floor(900*Math.random())).where("difficulty","==",t).orderBy("randomIndex").limit(2*Math.ceil(s/i.length))).get();c.empty||n.push(...c.docs.map(e=>({id:e.id,question:decodeHTML(e.data().question),correct:decodeHTML(e.data().correct_answer),options:shuffle([...e.data().incorrect_answers.map(decodeHTML),decodeHTML(e.data().correct_answer)]),category:o,subcategory:e.data().subcategory||"",difficulty:e.data().difficulty||t,titbits:e.data().titbits||"",image_keyword:e.data().image_keyword||null})))}return 0===n.length?(console.warn(`No questions found for ${e}, falling back to general knowledge`),showError(`No questions available for ${e}. Loading general knowledge instead.`),fetchfbQuestions("general knowledge",s,t)):(console.log("Fetched questions:",n),localStorage.setItem("fbQuestionsCache",JSON.stringify({...JSON.parse(localStorage.getItem("fbQuestionsCache")||"{}"),[a]:{questions:n,timestamp:Date.now()}})),processfbQuestions(shuffle(n),s))}function processfbQuestions(e,t){e=e.filter(e=>!state.fbUsedQuestions.includes(e.id)),t=shuffle(e).slice(0,Math.min(t,e.length));return state.fbUsedQuestions.push(...t.map(e=>e.id)),localStorage.setItem("fbUsedQuestions",JSON.stringify(state.fbUsedQuestions.slice(-500))),t.map(e=>({...e,options:shuffle([...e.options]),image_keyword:e.image_keyword||null}))}function decodeHTML(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}function shuffle(e){var t=[...e];for(let e=t.length-1;0<e;e--){var s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}function toInitCaps(e){return e.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function updateDifficultyDisplay(){var e=els.difficultyDisplay(),t=els.difficultyBox();if(e&&t)if(t.classList.remove("easy","medium","hard","mixed"),SPECIAL_QUIZ_TYPES.includes(state.category))e.textContent="Mixed",t.classList.add("mixed");else switch(state.difficulty){case"easy":e.textContent="Easy",t.classList.add("easy");break;case"medium":e.textContent="Medium",t.classList.add("medium");break;case"hard":e.textContent="Hard",t.classList.add("hard");break;default:e.textContent="Mixed",t.classList.add("mixed")}}function updateTimerUI(){state.timeLeft=state.isTimedMode?timers[state.timerDuration]:null;var e=els.questionTimer()?.parentElement;state.isTimedMode?(toggleClass(e,"remove","hidden"),els.questionTimer()&&(els.questionTimer().textContent=state.timeLeft)):(toggleClass(e,"add","hidden"),els.questionTimer()&&(els.questionTimer().textContent="N/A"))}function initTriviaGame(e){loadMuteState(),state.rememberSettings=JSON.parse(localStorage.getItem("triviaMasterRememberSettings"))||!1,state.showSettingsOnStart=!state.rememberSettings&&!SPECIAL_QUIZ_TYPES.includes(e),state.category=e,SPECIAL_QUIZ_TYPES.includes(e)?(state.isTimedMode=!0,state.timerDuration="quick",state.selectedQuestions=10,state.difficulty="mixed",localStorage.setItem("triviaMasterTimedMode","true"),localStorage.setItem("triviaMasterTimerDuration","quick"),messages.zero=["Don't worry! These were starter questions.","Everyone starts somewhere! Try again?","Basic knowledge builds up over time!","Ready for another quick try?"]):(state.isTimedMode=JSON.parse(localStorage.getItem("triviaMasterTimedMode"))||!0,state.timerDuration=localStorage.getItem("triviaMasterTimerDuration")||"long",state.rememberSettings=JSON.parse(localStorage.getItem("triviaMasterRememberSettings"))||!0,state.difficulty=localStorage.getItem("triviaMasterDifficulty")||"mixed"),els.game().classList.add("active"),els.game().classList.remove("hidden"),els.summary().classList.remove("active"),console.log("Initializing game for category:",e),trackEvent("game_start","game",e,1),state.questions=[],state.current=0,state.score=0,state.answers=[],state.isScoreSaved=!1,state.isNextPending=!1,updateTimerUI(),els.score().textContent="0",updatePlayerCount(e),state.showSettingsOnStart?showSettingsPanel(!0):startGameWithSettings(e),setupEvents()}async function showQuestion(){toggleClass(document.querySelector(".app-footer"),"add","hidden"),els.question().classList.remove("correct-bg","wrong-bg");let s=state.questions[state.current];if(!s)return endGame();var e="general knowledge"===s.category?"general knowledge":toInitCaps(s.category),t=(els.question().innerHTML='<div class="question-loading">Loading question...</div>',s.image_keyword||extractKeywordNLP(s.question));let a=imageCache[t]||null,o="";(a=a||await fetchImage(t))&&(o+=`
            <div class="question-image-container">
                <img src="${a}" alt="${t}" class="question-image">
            </div>
        `),o+=`
        <div class="question-text">${s.question}</div>
        <div class="question-meta">
            <div class="question-category">${e}<span class="question-difficulty ${s.difficulty}">${toInitCaps(s.difficulty)}</span></div>
            ${s.subcategory?`<div class="question-subcategory">${s.subcategory}</div>`:""}
        </div>
    `,els.question().innerHTML=o,els.options().innerHTML=s.options.map((e,t)=>`<button style="animation-delay: ${.1*t}s" data-correct="${e===s.correct}">${e}</button>`).join(""),els.questionCounter()&&(els.questionCounter().textContent=state.current+1+"/"+state.selectedQuestions),toggleClass(els.game(),"add","active"),toggleClass(els.summary(),"remove","active"),els.questionTimer().textContent=state.isTimedMode?state.timeLeft:"N/A",setupOptionEvents(),startTimer()}function setupOptionEvents(){var e=els.options();e?(e.querySelectorAll("button").forEach(e=>{e.removeEventListener("click",handleOptionClick),e.addEventListener("click",handleOptionClick)}),els.nextBtn().classList.remove("visible")):console.error("Options container (#options) not found in DOM")}function handleOptionClick(e){console.log("Option button clicked:",e.target.textContent,"data-correct:",e.target.dataset.correct),checkAnswer("true"===e.target.dataset.correct)}function startTimer(){clearInterval(state.timerId),state.isTimedMode?(state.timeLeft=timers[state.timerDuration],els.questionTimer().textContent=state.timeLeft,state.timerId=setInterval(()=>{--state.timeLeft<=0&&(clearInterval(state.timerId),handleTimeout()),els.questionTimer().classList.add("urgent"),state.timeLeft<=5&&playSound("tick"),els.questionTimer().textContent=state.timeLeft},1e3),state.isMuted||playSound("tick")):els.questionTimer().textContent="N/A"}function handleTimeout(){state.isTimedMode&&(els.question().classList.add("wrong-bg"),checkAnswer(!1))}function checkAnswer(e){stopSound("tick"),playSound(e?"correct":"wrong"),state.answers.push({correct:e}),clearInterval(state.timerId),els.question().classList.remove("correct-bg","wrong-bg"),els.question().classList.add(e?"correct-bg":"wrong-bg"),els.options().querySelectorAll("button").forEach(e=>{e.disabled=!0,e.classList.add("true"===e.dataset.correct?"correct":"wrong")}),e&&(state.score+=state.isTimedMode?10*state.timeLeft+50:100),els.score().textContent=state.score;var e=state.questions[state.current],t=els.question().querySelector(".question-titbits");t&&t.remove(),e.titbits&&((t=document.createElement("div")).className="question-titbits",t.innerHTML='<span class="titbits-icon">💡</span> Fun Fact: '+e.titbits,els.question().appendChild(t)),state.current<state.selectedQuestions-1?(els.nextBtn().classList.add("visible"),state.isNextPending=!0,state.isTimedMode&&setTimeout(()=>{state.isNextPending&&handleNextQuestion()},2e3)):setTimeout(endGame,1e3)}function handleNextQuestion(){state.isNextPending&&(state.isNextPending=!1,els.nextBtn().classList.remove("visible"),(state.current++<state.selectedQuestions-1?showQuestion:endGame)())}async function endGame(){console.log("Starting endGame, answers:",state.answers.length,"questions:",state.selectedQuestions);var t=state.answers.filter(e=>e.correct).length,s=(trackEvent("game_complete","performance",`${t}/${state.selectedQuestions} correct`,state.score),els.game()),a=els.summary(),o=els.highscores();if(s&&a&&o){s.classList.add("hidden"),a.classList.add("active"),o.classList.remove("hidden"),document.querySelector(".app-footer")?.classList.remove("hidden"),clearInterval(state.timerId),stopAllSounds();var i=state.questions[0]?.category||"general knowledge";let e=null;try{var r=await db.collection("scores").where("category","==",i).orderBy("score","desc").limit(1).get();e=r.empty?null:r.docs[0].data()}catch(e){console.error("endGame: Error fetching global high score:",e)}try{await saveHighScore()}catch(e){console.error("endGame: Error in saveHighScore:",e),showError("Failed to save high score. Please try again.")}try{await showSummary(e)}catch(e){console.error("endGame: Error in showSummary:",e)}SPECIAL_QUIZ_TYPES.includes(i)?(r=document.querySelector(".action-buttons"))&&(r.innerHTML=`
                <div class="progress-message">
                    <p>You've completed today's ${toInitCaps(i)} challenge!</p>
                    <p>New questions in <span id="daily-reset-timer"></span></p>
                    <button id="upgrade-btn" class="btn primary">Try Regular Quiz</button>
                    <a href="/" class="btn"><span class="material-icons">home</span> Back Home</a>
                </div>`,(r=document.getElementById("upgrade-btn"))&&r.addEventListener("click",()=>{state.isTimedMode=!1,state.selectedQuestions=10,localStorage.removeItem("triviaMasterTimedMode"),localStorage.removeItem("triviaMasterTimerDuration"),initTriviaGame("general knowledge")}),updateDailyResetTimer(),setInterval(updateDailyResetTimer,1e3)):(r=document.querySelector(".action-buttons"))&&(r.innerHTML=`
                <button class="btn primary" id="restart-btn">
                    <span class="material-icons">replay</span>Play Again
                </button>
                <a href="/" class="btn"><span class="material-icons">home</span> Back Home</a>`,r=document.getElementById("restart-btn"))&&r.addEventListener("click",restartGame),addShareButtons(state.score,t,state.selectedQuestions,i),state.questions=[],state.current=0,state.score=0,state.answers=[],state.isScoreSaved=!1,state.isNextPending=!1}else console.error("DOM elements missing:",{gameScreen:!!s,summaryScreen:!!a,highscores:!!o})}function updateDailyResetTimer(){var e=new Date,t=new Date,t=(t.setHours(24,0,0,0),t-e),e=Math.floor(t/36e5),t=Math.floor(t%36e5/6e4),s=document.getElementById("daily-reset-timer");s&&(s.textContent=e+`h ${t}m`)}function showSettingsPanel(e){var t=document.getElementById("settings-panel"),s=document.getElementById("timed-mode"),a=document.getElementById("mode-label"),o=document.getElementById("timer-duration"),i=document.getElementById("difficulty-level"),r=document.getElementById("remember-settings");t&&s&&a&&o&&i&&r&&(s.checked=state.isTimedMode,a.textContent=state.isTimedMode?"Timed":"Non-Timed",o.value=state.timerDuration,o.parentElement.style.display=state.isTimedMode?"flex":"none",i.value=state.difficulty||"mixed",r.checked=state.rememberSettings,t.classList.remove("hidden"),s=document.getElementById("close-settings-btn"),e&&s?(s.disabled=!0,s.style.opacity="0.5",s.style.cursor="not-allowed"):s&&(s.disabled=!1,s.style.opacity="1",s.style.cursor="pointer"))}function startGameWithSettings(e){fetchQuestions(e).then(e=>{preFetchImages(state.questions=e).then(()=>{showQuestion()}).catch(e=>{console.error("Error pre-fetching images:",e),showQuestion()})}).catch(e=>{console.error("Error fetching questions:",e),showError(e.message||"Failed to load questions.")})}function restartGame(){trackEvent("restart_game","navigation","from_summary"),state.usedQuestions.clear(),state.questions=[],state.current=0,state.score=0,state.answers=[],updateTimerUI(),els.score().textContent="0",els.game().classList.remove("hidden"),els.game().classList.add("active"),els.summary().classList.remove("active"),els.highscores().classList.add("hidden"),localStorage.removeItem(CACHE.QUESTIONS),initTriviaGame(state.category)}function generateShareUrls(e,t,s,a){t=window.location.origin+`/.netlify/functions/share?score=${e}&correct=${t}&total=${s}&category=`+encodeURIComponent(a),s=`I scored ${e} points in ${a} trivia! Can you beat me? `+t;return{facebook:"https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(t),twitter:"https://twitter.com/intent/tweet?text="+encodeURIComponent(s),whatsapp:"https://wa.me/?text="+encodeURIComponent(s),directUrl:t}}function addShareButtons(e,t,s,a){var o,i=document.querySelector(".action-buttons");i?((o=i.querySelector(".share-buttons"))&&o.remove(),e=`
        <div class="share-buttons">
            <p class="share-title">Share your score:</p>
            <div class="share-buttons-row">
                <a href="${(o=generateShareUrls(e,t,s,a)).facebook}" target="_blank" class="share-btn facebook" aria-label="Share on Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="${o.twitter}" target="_blank" class="share-btn twitter" aria-label="Share on Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="${o.whatsapp}" target="_blank" class="share-btn whatsapp" aria-label="Share on WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </div>
        </div>
    `,i.insertAdjacentHTML("beforeend",e)):console.error("Action buttons container not found")}async function showSummary(e){console.log("showSummary: state.answers:",state.answers),console.log("showSummary: state.answers.length:",state.answers.length),console.log("showSummary: correctCount:",state.answers.filter(e=>e.correct).length);var t=state.isTimedMode?state.selectedQuestions*timers[state.timerDuration]-state.timeLeft:0,s=state.answers.filter(e=>e.correct).length,a=state.questions[0]?.category||"general knowledge";let o,i;i=0===s?o="zero":s>=.9*state.selectedQuestions?o="gold":s>=.7*state.selectedQuestions?o="silver":o="bronze";var r,n,c=messages[o][Math.floor(Math.random()*messages[o].length)],l=els.highscoresList();l?((r=document.querySelector(".performance-message"))&&r.classList.add(i),l.innerHTML='<div class="loading-indicator"><div class="loading-spinner"></div><p>Loading high scores...</p></div>',r=els.correctCount(),l=els.timeUsed(),n=els.resultMessage(),r&&l&&n?(r.textContent=s+"/"+state.selectedQuestions,l.textContent=state.isTimedMode?`${Math.floor(t/60)}m ${(t%60).toString().padStart(2,"0")}s`:"N/A",n.innerHTML=c,e&&n.insertAdjacentHTML("afterend",`
            <div class="global-high-score">
                <div class="global-high-details">
                    <div class="global-high-text"> 🏆 Global High in ${toInitCaps(a)}: ${e.score} by ${e.name}</div>
                </div>
            </div>
            ${e.score>state.score?`<div class="motivation-text">You're ${e.score-state.score} points behind the leader!</div>`:'<div class="global-champion-message">🎉 You beat the global high score! Submit your score to claim the crown!</div>'}
        `),document.getElementById("total-score").textContent=state.score,els.highscoresList().innerHTML=state.highScores.length?state.highScores.map((e,t)=>`
            <div class="highscore-entry compact">
                <span class="name">${t+1}. ${e.name}</span>
                <span class="score">${e.score}</span>
            </div>
        `).join(""):'<p class="no-scores">No high scores yet</p>',await updateHighScores()):console.error("Summary elements missing:",{correctCount:!!r,timeUsed:!!l,resultMessage:!!n})):console.error("Highscores list (#highscores-list) not found in DOM")}async function saveHighScore(){if(state.isScoreSaved||!state.score)console.log("saveHighScore: Skipped - isScoreSaved:",state.isScoreSaved,"score:",state.score);else{var e=CATEGORY_ALIASES[state.questions[0]?.category]||state.questions[0]?.category||"general knowledge",s=prompt("Enter your name:","Anonymous")||"Anonymous";console.log("saveHighScore: Saving score:",{name:s,score:state.score,category:e,difficulty:state.difficulty,timestamp:firebase.firestore.Timestamp.now()});let t=2;for(;0<t;)try{return await db.collection("scores").add({name:s,score:state.score,category:e,difficulty:state.difficulty,timestamp:firebase.firestore.Timestamp.now()}),state.isScoreSaved=!0,void console.log("saveHighScore: Score saved successfully")}catch(e){console.error("saveHighScore: Error saving score (attempt "+(3-t)+"):",e),0===--t&&showError("Failed to save high score after retries. Please try again.")}}}async function updateHighScores(){var t=els.highscoresList();if(t){var e=CATEGORY_ALIASES[state.questions[0]?.category]||state.questions[0]?.category||"general knowledge";try{var s=await db.collection("scores").where("category","==",e).where("difficulty","==",state.difficulty).orderBy("score","desc").limit(5).get();state.highScores=s.docs.map(e=>e.data()),t.innerHTML=state.highScores.length?state.highScores.map((e,t)=>`
                <div class="highscore-entry">
                    <span class="rank">${t+1}.</span>
                    <span class="name">${e.name}</span>
                    <span class="score">${e.score}</span>
                </div>
            `).join(""):'<p class="no-scores">No high scores yet for this category. Play a game to start!</p>'}catch(e){console.error("updateHighScores: Error fetching global high scores:",e),t.innerHTML='<p class="no-scores">Error loading high scores. Please try again later.</p>'}}}function setupEvents(){var e=document.getElementById("next-btn");e&&e.addEventListener("click",handleNextQuestion);let t=document.getElementById("mute-btn");t&&t.addEventListener("click",()=>{state.isMuted=!state.isMuted,localStorage.setItem("triviaMasterMuteState",state.isMuted);var e=t.querySelector(".material-icons");e&&(e.textContent=state.isMuted?"volume_off":"volume_up"),state.isMuted?stopAllSounds():els.game().classList.contains("active")&&state.isTimedMode&&playSound("tick")});e=document.getElementById("settings-btn");let o=document.getElementById("settings-panel"),i=document.getElementById("timed-mode"),s=document.getElementById("mode-label");var a=document.getElementById("save-settings-btn"),r=document.getElementById("close-settings-btn");let n=document.getElementById("timer-duration"),c=document.getElementById("difficulty-level");a&&a.addEventListener("click",()=>{var e=i?i.checked:state.isTimedMode,t=n?n.value:state.timerDuration,s=c?c.value:state.difficulty,a=document.getElementById("remember-settings")?.checked||!1;state.isTimedMode=e,state.timerDuration=t,state.difficulty=s,state.rememberSettings=a,localStorage.setItem("triviaMasterTimedMode",state.isTimedMode),localStorage.setItem("triviaMasterTimerDuration",state.timerDuration),localStorage.setItem("triviaMasterDifficulty",state.difficulty),localStorage.setItem("triviaMasterRememberSettings",state.rememberSettings),updateDifficultyDisplay(),toggleClass(o,"add","hidden"),state.showSettingsOnStart?(state.showSettingsOnStart=!1,startGameWithSettings(state.category)):(state.current=0,updateTimerUI(),showQuestion())}),e&&o&&e.addEventListener("click",()=>{toggleClass(o,"remove","hidden"),i&&(i.checked=state.isTimedMode),s&&(s.textContent=state.isTimedMode?"Timed":"Non-Timed"),n&&(n.value=state.timerDuration,n.parentElement.style.display=state.isTimedMode?"flex":"none"),c&&(c.value=state.difficulty)}),i&&i.addEventListener("change",()=>{s.textContent=i.checked?"Timed":"Non-Timed",n&&(n.parentElement.style.display=i.checked?"flex":"none")}),a&&a.addEventListener("click",()=>{var e=i?i.checked:state.isTimedMode,t=n?n.value:state.timerDuration,s=c?c.value:state.difficulty;e===state.isTimedMode&&t===state.timerDuration&&s===state.difficulty||(state.isTimedMode=e,state.timerDuration=t,state.difficulty=s,localStorage.setItem("triviaMasterTimedMode",state.isTimedMode),localStorage.setItem("triviaMasterTimerDuration",state.timerDuration),localStorage.setItem("triviaMasterDifficulty",state.difficulty),state.current=0,updateTimerUI(),showQuestion()),toggleClass(o,"add","hidden")}),r&&r.addEventListener("click",()=>{toggleClass(o,"add","hidden")}),window.addEventListener("beforeunload",()=>{clearInterval(state.timerId),stopAllSounds()})}function setupStartQuizListener(){document.addEventListener("startQuiz",e=>{var{category:e,isTimedMode:t}=e.detail;state.isTimedMode=t,initTriviaGame(e)})}document.addEventListener("DOMContentLoaded",()=>{var e;setupStartQuizListener(),loadMuteState(),window.location.pathname.includes("catalog.html")||initTriviaGame(1<(e=window.location.pathname.split("/").filter(e=>e)).length?e[1].replace(/-/g," "):"general knowledge")}),window.triviaGame={endGame:endGame};export{initTriviaGame};
