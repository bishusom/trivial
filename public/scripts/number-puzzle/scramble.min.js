function initPuzzle(){console.log("Starting Number Scramble");let gameState={numbers:[],target:null,score:0,currentExpression:"",usedNumbers:[],usedIndices:[],level:1,xp:0,coins:0,difficulty:"easy",gamesPlayed:{easy:0,medium:0,hard:0},consecutiveHardWins:0,unlockedFeatures:[],challengeMode:null,stats:{puzzlesSolved:0,totalPoints:0,hintsUsed:0},isMuted:JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1,timeLeft:60,timerInterval:null},audioElements={select:new Audio("/audio/click.mp3"),found:new Audio("/audio/correct.mp3"),win:new Audio("/audio/win.mp3"),error:new Audio("/audio/wrong.mp3")},elements={tilesContainer:document.getElementById("scramble-tiles"),operatorsContainer:document.getElementById("scramble-operators"),submitBtn:document.getElementById("scramble-submit"),clearBtn:document.getElementById("scramble-clear"),newBtn:document.getElementById("scramble-new"),hintBtn:document.getElementById("scramble-hint"),targetEl:document.getElementById("scramble-target"),scoreEl:document.getElementById("scramble-score"),levelEl:document.getElementById("scramble-level"),timeEl:document.getElementById("scramble-time")||createTimeElement(),expressionEl:document.getElementById("scramble-expression")||createExpressionElement(),coinsEl:document.getElementById("scramble-coins")};function playSound(t){gameState.isMuted?console.log(`Sound ${t} skipped: muted`):audioElements[t]&&(audioElements[t].currentTime=0,audioElements[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e)))}function stopSound(e){audioElements[e]&&(audioElements[e].pause(),audioElements[e].currentTime=0)}function stopAllSounds(){Object.keys(audioElements).forEach(e=>stopSound(e))}function createTimeElement(){var e=document.createElement("span"),t=(e.id="scramble-time",e.className="timer-value",document.querySelector(".puzzle-meta"));return t&&t.appendChild(e),e}function createExpressionElement(){var e=document.createElement("div"),t=(e.id="scramble-expression",e.className="scramble-expression",document.getElementById("scramble-target"));return t&&t.parentNode.insertBefore(e,t.nextSibling),e}function startTimer(){console.log("Starting timer"),gameState.timerInterval&&clearInterval(gameState.timerInterval),gameState.timeLeft=60,updateTimer(),gameState.timerInterval=setInterval(()=>{console.log("Timer tick: "+gameState.timeLeft),gameState.timeLeft=Math.max(0,gameState.timeLeft-1),updateTimer(),gameState.timeLeft<=0&&(console.log("Timer expired"),clearInterval(gameState.timerInterval),gameState.timerInterval=null,updateFeedback("error","Time's up!"),gameState.consecutiveHardWins=0,playSound("error"),setTimeout(generateNewPuzzle,2e3))},1e3)}function updateTimer(){var e,t;elements.timeEl?(e=Math.floor(gameState.timeLeft/60),t=gameState.timeLeft%60,elements.timeEl.textContent=`Time: ${e}:`+t.toString().padStart(2,"0"),elements.timeEl.className="timer-value "+(gameState.timeLeft<=10?"time-critical":"")):console.warn("Timer element not found")}function showConfetti(t={}){if(console.log("Triggering confetti"),"undefined"==typeof confetti)console.error("Confetti library not loaded");else{let e={particleCount:100,spread:70,origin:{y:.6},colors:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]};confetti({...e,...t}),.5<Math.random()&&setTimeout(()=>{confetti({...e,...t,angle:180*Math.random()-90,origin:{x:Math.random(),y:.6}})},300)}}function trackEvent(e,t,a,n){"undefined"!=typeof gtag&&gtag("event",e,{event_category:t,event_label:a,value:n})}function clearInput(){gameState.currentExpression="",gameState.usedNumbers=[],gameState.usedIndices=[],renderTiles(),renderExpression(),updateFeedback("info","Cleared"),playSound("select")}function initGame(){setupEventListeners(),generateNewPuzzle(),updateUI(),gameState.isMuted&&stopAllSounds();var e=document.querySelector("#mute-btn .material-icons");e&&(e.textContent=gameState.isMuted?"volume_off":"volume_up")}function generateNewPuzzle(){trackEvent("scramble_started","number_scramble",1),gameState.currentExpression="",gameState.usedNumbers=[],gameState.usedIndices=[],gameState.numbers=generateNumbers(),gameState.target=generateTarget(),renderTiles(),renderOperators(),renderExpression(),updateUI(),startTimer(),flashTarget()}function flashTarget(){elements.targetEl.style.transition="all 0.3s",elements.targetEl.style.transform="scale(1.2)",elements.targetEl.style.color="#ffd700",setTimeout(()=>{elements.targetEl.style.transform="scale(1)",elements.targetEl.style.color=""},500)}function generateNumbers(){var t=6+Math.floor(gameState.level/5),a=[];for(let e=0;e<t;e++){let e=9;"medium"===gameState.difficulty&&(e=15),"hard"===gameState.difficulty&&(e=25),"expert"===gameState.difficulty&&(e=50),a.push(Math.floor(Math.random()*e)+1)}return a}function generateTarget(){let e=10,t=100;return"medium"===gameState.difficulty?(e=50,t=200):"hard"===gameState.difficulty?(e=100,t=500):"expert"===gameState.difficulty&&(e=200,t=1e3),Math.floor(Math.random()*(t-e+1))+e}function updateDifficulty(){gameState.gamesPlayed.easy<5?gameState.difficulty="easy":gameState.gamesPlayed.medium<5?gameState.difficulty="medium":gameState.difficulty="hard"}function renderTiles(){elements.tilesContainer.innerHTML="",gameState.numbers.forEach((e,t)=>{var a=document.createElement("div");a.className="scramble-tile "+(gameState.usedIndices.includes(t)?"used":""),a.textContent=e,a.dataset.index=t,a.addEventListener("click",()=>selectNumber(t)),elements.tilesContainer.appendChild(a)})}function renderOperators(){elements.operatorsContainer.innerHTML="";["+","-","*","/"].forEach(e=>{var t=document.createElement("button");t.className="btn small",t.textContent=e,t.addEventListener("click",()=>addOperator(e)),elements.operatorsContainer.appendChild(t)})}function renderExpression(){elements.expressionEl.innerHTML=gameState.currentExpression?`Current: <span class="expression-value">${gameState.currentExpression}</span>`:'Current: <span class="expression-value">Empty</span>',elements.expressionEl.className="scramble-expression"}function selectNumber(e){gameState.usedIndices.includes(e)||(gameState.currentExpression+=gameState.numbers[e],gameState.usedIndices.push(e),gameState.usedNumbers.push(gameState.numbers[e]),renderTiles(),renderExpression(),updateFeedback("info","Current: "+gameState.currentExpression),playSound("select"))}function addOperator(e){gameState.currentExpression+=e,renderExpression(),updateFeedback("info","Current: "+gameState.currentExpression),playSound("select")}function submitSolution(){if(gameState.currentExpression&&gameState.currentExpression!==gameState.target.toString())if(/[\+\-\*\/]/.test(gameState.currentExpression))try{let result=eval(gameState.currentExpression);Math.abs(result-gameState.target)<1e-4?handleCorrectSolution():handleIncorrectSolution(result)}catch(error){console.error("Invalid expression:",error),updateFeedback("error","Invalid mathematical expression"),playSound("error")}else updateFeedback("error","Use at least one operator (+, -, *, /)"),playSound("error");else updateFeedback("error","Create an expression using the numbers!"),playSound("error")}function handleCorrectSolution(){let e=10;if("medium"===gameState.difficulty&&(e*=1.5),"hard"===gameState.difficulty&&(e*=2),"expert"===gameState.difficulty&&(e*=3),e=Math.round(e)||0,gameState.score+=e,gameState.stats.puzzlesSolved++,gameState.stats.totalPoints+=e,gameState.gamesPlayed[gameState.difficulty]++,"hard"===gameState.difficulty){if(gameState.consecutiveHardWins++,5<=gameState.consecutiveHardWins)return endGame(),void trackEvent("scramble_end","number_scramble",1)}else gameState.consecutiveHardWins=0;clearInterval(gameState.timerInterval),gameState.timerInterval=null,addXP(e),addCoins(Math.floor(e/2)),updateDifficulty(),updateFeedback("success",`Correct! ${gameState.currentExpression} = ${gameState.target} (+${e} points)`),playSound("win"),showConfetti(),updateUI(),setTimeout(()=>{renderExpression(),generateNewPuzzle()},1500)}function handleIncorrectSolution(e){updateFeedback("error",`Incorrect! ${gameState.currentExpression} = ${e} (Target: ${gameState.target})`),"hard"===gameState.difficulty&&(gameState.consecutiveHardWins=0),playSound("error")}function endGame(){clearInterval(gameState.timerInterval),gameState.timerInterval=null,updateFeedback("success","Congratulations! You won the game with 5 consecutive hard-level victories!"),elements.submitBtn.disabled=!0,elements.clearBtn.disabled=!0,elements.newBtn.disabled=!0,elements.hintBtn.disabled=!0,elements.tilesContainer.innerHTML="",elements.operatorsContainer.innerHTML="",elements.expressionEl.innerHTML="";let e=document.createElement("div"),t=(e.className="victory-screen",e.innerHTML=`
            <h2>Victory!</h2>
            <p>Congratulations! You won with 5 consecutive hard-level victories!</p>
            <p>Score: ${gameState.score} | Level: ${gameState.level}</p>
            <div class="countdown">Starting new game in 5...</div>
        `,document.body.appendChild(e),showConfetti({particleCount:200,spread:100}),5),a=e.querySelector(".countdown"),n=setInterval(()=>{t--,a.textContent=`Starting new game in ${t}...`,t<=0&&(clearInterval(n),e.remove(),gameState.consecutiveHardWins=0,gameState.score=0,gameState.level=1,gameState.xp=0,gameState.gamesPlayed={easy:0,medium:0,hard:0},initGame())},1e3)}function addXP(e){gameState.xp+=e;e=100*gameState.level;gameState.xp>=e&&(gameState.level++,gameState.xp=gameState.xp-e,showRewardNotification("Level Up! Now level "+gameState.level,100),showConfetti({particleCount:150,spread:80})),updateUI()}function addCoins(e){gameState.coins+=e,0<e&&showRewardNotification(`+${e} Coins`,e),updateUI()}function showRewardNotification(e,t){let a=document.createElement("div");a.className="reward-notification",a.innerHTML=`
            <div>${e}</div>
            ${t?`<div class="reward-amount">+${t}</div>`:""}
        `,document.body.appendChild(a),setTimeout(()=>{a.classList.add("show")},10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{a.remove()},300)},3e3)}function updateFeedback(e,t){elements.expressionEl.textContent=t,elements.expressionEl.className="scramble-expression feedback-"+e,"success"!==e&&"error"!==e||setTimeout(()=>{renderExpression()},1500)}function updateUI(){elements.targetEl.innerHTML=`
            Target: <span class="difficulty-${gameState.difficulty}"><b>${gameState.target}</b></span>
            <span class="difficulty-${gameState.difficulty}">(${gameState.difficulty})</span>
        `,elements.scoreEl.textContent="Score: "+gameState.score,elements.levelEl&&(elements.levelEl.textContent="Level: "+gameState.level),elements.coinsEl&&(elements.coinsEl.textContent="Coins: "+gameState.coins)}function setupEventListeners(){elements.submitBtn.addEventListener("click",submitSolution),elements.clearBtn.addEventListener("click",clearInput),elements.newBtn.addEventListener("click",generateNewPuzzle),elements.hintBtn.addEventListener("click",showHint);var e=document.getElementById("mute-btn");let t=document.querySelector("#mute-btn .material-icons");e&&e.addEventListener("click",()=>{gameState.isMuted=!gameState.isMuted,localStorage.setItem("triviaMastermuteState",gameState.isMuted),t&&(t.textContent=gameState.isMuted?"volume_off":"volume_up"),gameState.isMuted&&stopAllSounds()})}function showHint(){gameState.stats.hintsUsed++,0<gameState.numbers.length&&(updateFeedback("hint","Try starting with "+gameState.numbers[0]),playSound("select"))}initGame()}document.addEventListener("DOMContentLoaded",()=>{initPuzzle()});export{initPuzzle};
