let messages={gold:["üèÜ Trivia Deity! The knowledge gods bow before you! Can you maintain your reign?","üß† Mind = Blown! Think you can top this perfect score? Try again!","ü§Ø Unstoppable Genius! Ready for an even bigger challenge next round?","üéñÔ∏è Absolute Legend! The leaderboard needs your name again!"],silver:["‚ú® Brainiac Alert! One more round could push you to perfection!","üöÄ Knowledge Rocket! You're just one launch away from trivia greatness!","üíé Diamond Mind! Polish your skills further with another game!","üß© Puzzle Master! Can you complete the picture perfectly next time?"],bronze:["üëç Solid Effort! Your next attempt could be your breakthrough!","üìö Bookworm Rising! Every replay makes you wiser - try again!","üí° Bright Spark! Your knowledge is growing - fuel it with another round!","üèÖ Contender Status! The podium is within reach - one more try!"],zero:["üí• Knowledge Explosion Incoming! Stick around - the next attempt will be better!","üéØ Fresh Start! Now that you've warmed up, the real game begins!","üî• Fueling Curiosity! Your learning journey starts here - play again!","üöÄ Launch Pad Ready! First attempts are just practice - try for real now!","üå± Seeds of Knowledge Planted! Water them with another try!"],default:["üå± Sprouting Scholar! Every replay makes you stronger - continue your journey!","ü¶â Wise Owl in Training! The more you play, the wiser you become!","üìñ Chapter 1 Complete! Turn the page to your next knowledge adventure!","üß≠ Learning Compass Active! Your next game could be your true north!"]},els={game:()=>document.querySelector(".game-screen"),summary:()=>document.querySelector(".summary-screen"),question:()=>document.getElementById("question"),options:()=>document.getElementById("options"),nextBtn:()=>document.getElementById("next-btn"),score:()=>document.getElementById("score"),questionTimer:()=>document.getElementById("question-timer"),highscores:()=>document.querySelector(".highscores"),highscoresList:()=>document.getElementById("highscores-list"),resultMessage:()=>document.getElementById("result-message"),correctCount:()=>document.getElementById("correct-count"),timeUsed:()=>document.getElementById("time-used"),questionCounter:()=>document.getElementById("question-counter"),difficultyDisplay:()=>document.getElementById("difficulty-level-display"),difficultyBox:()=>document.querySelector(".difficulty-box")},timers={quick:10,long:60},audio={tick:document.getElementById("tick-sound"),correct:document.getElementById("correct-sound"),wrong:document.getElementById("wrong-sound")},imageCache=(audio.tick.loop=!0,{}),SPECIAL_QUIZ_TYPES=["daily","90s movie trivia","pub quiz","famous quotes","country capitals"],CATEGORY_ALIASES={"board games":"board-games","video games":"video-games","famous quotes":"famous-quotes","country capitals":"country-capitals","90s movie trivia":"90s-movie-trivia","pub quiz":"pub-quiz"},state={isMuted:!1,questions:[],current:0,score:0,timeLeft:null,timerId:null,highScores:[],answers:[],isScoreSaved:!1,isNextPending:!1,selectedQuestions:10,usedQuestions:new Set,fbUsedQuestions:JSON.parse(localStorage.getItem("fbUsedQuestions")||"[]"),fbUsedQuizIds:JSON.parse(localStorage.getItem("fbUsedQuizIds")||"[]"),isTimedMode:!0,timerDuration:"long",difficulty:"mixed",rememberSettings:!1,showSettingsOnStart:!0,category:"general knowledge"},nlp,QUIZ_TYPES=("undefined"!=typeof window&&window.nlp?(nlp=window.nlp,console.log("Found nlp")):(nlp={nouns:()=>({out:()=>[]}),adjectives:()=>({out:()=>[]})},console.log("Creating home-grown nlp")),{DAILY:"daily"}),CACHE={QUESTIONS:"trivia-questions-v1",EXPIRY:864e5};function trackEvent(e,t,s,a){"undefined"!=typeof gtag&&gtag("event",e,{event_category:t,event_label:s,value:a})}function toggleClass(e,t,s){e?.classList?.[t]?.(s)}function playSound(t){state.isMuted?console.log(`Sound ${t} skipped: muted`):(console.log("Playing sound: "+t),audio[t].play().catch(e=>console.error(`Error playing ${t} sound:`,e)))}function stopSound(e){console.log("Stopping sound: "+e),audio[e].pause(),audio[e].currentTime=0}function stopAllSounds(){console.log("Stopping all sounds"),["tick","correct","wrong"].forEach(e=>stopSound(e))}function loadMuteState(){state.isMuted=JSON.parse(localStorage.getItem("triviaMasterMuteState"))||!1;var e=localStorage.getItem("triviaMasterTimedMode"),e=(state.isTimedMode=null===e||JSON.parse(e),localStorage.getItem("triviaMasterTimerDuration")),e=(state.timerDuration=null!==e?e:"long",localStorage.getItem("triviaMasterDifficulty")),e=(state.difficulty=null!==e?e:"mixed",document.querySelector("#mute-btn .material-icons"));e&&(e.textContent=state.isMuted?"volume_off":"volume_up"),state.isMuted&&stopAllSounds()}function showError(e){let t=document.getElementById("error-message");t||((t=document.createElement("div")).id="error-message",t.className="error-message",t.innerHTML=`<div id="error-text">${e}</div><button id="retry-btn" class="btn small primary">Retry</button>`,els.game().appendChild(t),document.getElementById("retry-btn").addEventListener("click",()=>{initTriviaGame(state.category)})),t.classList.remove("hidden")}async function updatePlayerCount(e){try{var t=db.collection("playerCounts").doc(e),s=await t.get(),a=(s.exists?s.data().count:0)+1;await t.set({count:a,lastUpdated:firebase.firestore.FieldValue.serverTimestamp(),category:e},{merge:!0}),console.log("Updating player count: ",a)}catch(e){return console.error("Error updating player count:",e),Math.floor(40*Math.random())+100}}function extractKeywordNLP(e){var t=nlp(e),s=t.nouns().out("array");return 0<s.length||0<(s=t.adjectives().out("array")).length?s[0]:(t=e.replace("?","").split(" ")).find(e=>3<e.length)||t[0]}async function fetchImage(e){if(imageCache[e])return imageCache[e];console.log("Fetching image for",e);try{var t,s=await fetch("/.netlify/functions/get-image?keyword="+encodeURIComponent(e));if(s.ok)return(t=await s.json()).url?(imageCache[e]=t.url,t.url):null;throw new Error("HTTP error! status: "+s.status)}catch(e){return console.error("Error fetching image:",e),null}}async function preFetchQuestionImages(e){e=e.map(async t=>{t=t.image_keyword||extractKeywordNLP(t.question);if(!imageCache[t])try{var e=await fetchImage(t);e&&(imageCache[t]=e,(new Image).src=e)}catch(e){console.error(`Error pre-fetching image for "${t}":`,e)}return!0});await Promise.all(e),console.log("All images pre-fetched")}async function fetchQuestions(t){try{console.log("Fetching questions for category:",t);let e;return await preFetchQuestionImages(e=[QUIZ_TYPES.DAILY,QUIZ_TYPES.WEEKLY,QUIZ_TYPES.MONTHLY].includes(t.toLowerCase())?await fetchfbQuiz(t.toLowerCase()):await fetchfbQuestions(t,state.selectedQuestions,state.difficulty)),e}catch(e){throw console.error("Error in fetchQuestions:",e),showError(e.message||"Failed to load questions."),e}}async function fetchSpecialQuiz(e){let t=CATEGORY_ALIASES[e]||e;console.log("Fetching special quiz for:",t);var s=new Date,a=s.toISOString().split("T")[0],a=`fb-${t}-quiz-`+a,o=new Date,i=(o.setHours(24,0,0,0),JSON.parse(localStorage.getItem("fbQuizCache"))?.[a]);return i&&s<o?shuffle(i.questions):(o=await db.collection("triviaMaster").doc("questions").collection("items").where("category","==",t).where("randomIndex",">=",Math.floor(900*Math.random())).orderBy("randomIndex").limit(10).get()).empty?(console.warn(`No questions found for ${e}, falling back to general knowledge`),showError(`No questions available for ${e}. Loading general knowledge instead.`),fetchfbQuestions("general knowledge",10,"mixed")):(i=o.docs.map(e=>({id:e.id,question:decodeHTML(e.data().question),correct:decodeHTML(e.data().correct_answer),options:shuffle([...e.data().incorrect_answers.map(decodeHTML),decodeHTML(e.data().correct_answer)]),category:t,subcategory:e.data().subcategory,difficulty:e.data().difficulty,titbits:e.data().titbits||"",image_keyword:e.data().image_keyword||null})).slice(0,10),localStorage.setItem("fbQuizCache",JSON.stringify({...JSON.parse(localStorage.getItem("fbQuizCache")||"{}"),[a]:{questions:i,timestamp:s.getTime()}})),shuffle(i))}async function fetchfbQuestions(e,s=10,t="mixed"){var a=e.toLowerCase();let o=CATEGORY_ALIASES[e]||e;console.log("Fetching questions for category:",o,"difficulty:",t);var i="mixed"===t?["easy","medium","hard"]:[t],a=`fb_questions-${a}-`+t,n=JSON.parse(localStorage.getItem("fbQuestionsCache"))?.[a];if(n&&n.questions.length>=s&&n.questions.filter(e=>!state.fbUsedQuestions.includes(e.id)).length>=s)return console.log("Using cached questions:",n.questions),processfbQuestions(n.questions,s);var r=[];for(let t of i){let e=db.collection("triviaMaster").doc("questions").collection("items");var l=await(e=(e="general knowledge"!==o?e.where("category","==",o):e).where("randomIndex",">=",Math.floor(900*Math.random())).where("difficulty","==",t).orderBy("randomIndex").limit(2*Math.ceil(s/i.length))).get();l.empty||r.push(...l.docs.map(e=>({id:e.id,question:decodeHTML(e.data().question),correct:decodeHTML(e.data().correct_answer),options:shuffle([...e.data().incorrect_answers.map(decodeHTML),decodeHTML(e.data().correct_answer)]),category:o,subcategory:e.data().subcategory||"",difficulty:e.data().difficulty||t,titbits:e.data().titbits||"",image_keyword:e.data().image_keyword||null})))}return 0===r.length?(console.warn(`No questions found for ${e}, falling back to general knowledge`),showError(`No questions available for ${e}. Loading general knowledge instead.`),fetchfbQuestions("general knowledge",s,t)):(console.log("Fetched questions:",r),localStorage.setItem("fbQuestionsCache",JSON.stringify({...JSON.parse(localStorage.getItem("fbQuestionsCache")||"{}"),[a]:{questions:r,timestamp:Date.now()}})),processfbQuestions(shuffle(r),s))}function processfbQuestions(e,t){e=e.filter(e=>!state.fbUsedQuestions.includes(e.id)),t=shuffle(e).slice(0,Math.min(t,e.length));return state.fbUsedQuestions.push(...t.map(e=>e.id)),localStorage.setItem("fbUsedQuestions",JSON.stringify(state.fbUsedQuestions.slice(-500))),t.map(e=>({...e,options:shuffle([...e.options]),image_keyword:e.image_keyword||null}))}function decodeHTML(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}function shuffle(e){var t=[...e];for(let e=t.length-1;0<e;e--){var s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}function toInitCaps(e){return e.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function updateDifficultyDisplay(){var e=els.difficultyDisplay(),t=els.difficultyBox();if(e&&t)if(t.classList.remove("easy","medium","hard","mixed"),SPECIAL_QUIZ_TYPES.includes(state.category))e.textContent="Mixed",t.classList.add("mixed");else switch(state.difficulty){case"easy":e.textContent="Easy",t.classList.add("easy");break;case"medium":e.textContent="Medium",t.classList.add("medium");break;case"hard":e.textContent="Hard",t.classList.add("hard");break;default:e.textContent="Mixed",t.classList.add("mixed")}}function updateTimerUI(){state.timeLeft=state.isTimedMode?timers[state.timerDuration]:null;var e=els.questionTimer()?.parentElement;state.isTimedMode?(toggleClass(e,"remove","hidden"),els.questionTimer()&&(els.questionTimer().textContent=state.timeLeft)):(toggleClass(e,"add","hidden"),els.questionTimer()&&(els.questionTimer().textContent="N/A"))}function initTriviaGame(e){loadMuteState(),state.rememberSettings=JSON.parse(localStorage.getItem("triviaMasterRememberSettings"))||!1,state.showSettingsOnStart=!state.rememberSettings&&!SPECIAL_QUIZ_TYPES.includes(e),state.category=e,SPECIAL_QUIZ_TYPES.includes(e)?(state.isTimedMode=!0,state.timerDuration="quick",state.selectedQuestions=10,state.difficulty="mixed",localStorage.setItem("triviaMasterTimedMode","true"),localStorage.setItem("triviaMasterTimerDuration","quick"),messages.zero=["Don't worry! These were starter questions.","Everyone starts somewhere! Try again?","Basic knowledge builds up over time!","Ready for another quick try?"]):(state.isTimedMode=JSON.parse(localStorage.getItem("triviaMasterTimedMode"))||!0,state.timerDuration=localStorage.getItem("triviaMasterTimerDuration")||"long",state.rememberSettings=JSON.parse(localStorage.getItem("triviaMasterRememberSettings"))||!0,state.difficulty=localStorage.getItem("triviaMasterDifficulty")||"mixed"),els.game().classList.add("active"),els.game().classList.remove("hidden"),els.summary().classList.remove("active"),console.log("Initializing game for category:",e),trackEvent("game_start","game",e,1),state.questions=[],state.current=0,state.score=0,state.answers=[],state.isScoreSaved=!1,state.isNextPending=!1,updateTimerUI(),els.score().textContent="0",updatePlayerCount(e),state.showSettingsOnStart?showSettingsPanel(!0):startGameWithSettings(e),setupEvents()}async function showQuestion(){toggleClass(document.querySelector(".app-footer"),"add","hidden"),els.question().classList.remove("correct-bg","wrong-bg");let s=state.questions[state.current];if(!s)return endGame();var e="general knowledge"===s.category?"general knowledge":toInitCaps(s.category),t=(els.question().innerHTML='<div class="question-loading">Loading question...</div>',s.image_keyword||extractKeywordNLP(s.question)),a=imageCache[t]||null;let o="";a&&(o+=`
            <div class="question-image-container">
                <img src="${a}" alt="${t}" class="question-image" 
                     onerror="this.style.display='none'">
            </div>
        `),o+=`
        <div class="question-text">${s.question}</div>
        <div class="question-meta">
            <div class="question-category">${e}<span class="question-difficulty ${s.difficulty}">${toInitCaps(s.difficulty)}</span></div>
            ${s.subcategory?`<div class="question-subcategory">${s.subcategory}</div>`:""}
        </div>
    `,els.question().innerHTML=o,els.options().innerHTML=s.options.map((e,t)=>`<button style="animation-delay: ${.1*t}s" data-correct="${e===s.correct}">${e}</button>`).join(""),els.questionCounter()&&(els.questionCounter().textContent=state.current+1+"/"+state.selectedQuestions),toggleClass(els.game(),"add","active"),toggleClass(els.summary(),"remove","active"),els.questionTimer().textContent=state.isTimedMode?state.timeLeft:"N/A",setupOptionEvents(),startTimer()}function setupOptionEvents(){var e=els.options();e?(e.querySelectorAll("button").forEach(e=>{e.removeEventListener("click",handleOptionClick),e.addEventListener("click",handleOptionClick)}),els.nextBtn().classList.remove("visible")):console.error("Options container (#options) not found in DOM")}function handleOptionClick(e){console.log("Option button clicked:",e.target.textContent,"data-correct:",e.target.dataset.correct),checkAnswer("true"===e.target.dataset.correct)}function startTimer(){clearInterval(state.timerId),state.isTimedMode?(state.timeLeft=timers[state.timerDuration],els.questionTimer().textContent=state.timeLeft,state.timerId=setInterval(()=>{--state.timeLeft<=0&&(clearInterval(state.timerId),handleTimeout()),els.questionTimer().classList.add("urgent"),state.timeLeft<=5&&playSound("tick"),els.questionTimer().textContent=state.timeLeft},1e3),state.isMuted||playSound("tick")):els.questionTimer().textContent="N/A"}function handleTimeout(){state.isTimedMode&&(els.question().classList.add("wrong-bg"),checkAnswer(!1))}function checkAnswer(e){stopSound("tick"),playSound(e?"correct":"wrong"),state.answers.push({correct:e}),clearInterval(state.timerId),els.question().classList.remove("correct-bg","wrong-bg"),els.question().classList.add(e?"correct-bg":"wrong-bg"),els.options().querySelectorAll("button").forEach(e=>{e.disabled=!0,e.classList.add("true"===e.dataset.correct?"correct":"wrong")}),e&&(state.score+=state.isTimedMode?10*state.timeLeft+50:100),els.score().textContent=state.score;var e=state.questions[state.current],t=els.question().querySelector(".question-titbits");t&&t.remove(),e.titbits&&((t=document.createElement("div")).className="question-titbits",t.innerHTML='<span class="titbits-icon">üí°</span> Fun Fact: '+e.titbits,els.question().appendChild(t)),state.current<state.selectedQuestions-1?(els.nextBtn().classList.add("visible"),state.isNextPending=!0,state.isTimedMode&&setTimeout(()=>{state.isNextPending&&handleNextQuestion()},2e3)):setTimeout(endGame,1e3)}function handleNextQuestion(){state.isNextPending&&(state.isNextPending=!1,els.nextBtn().classList.remove("visible"),(state.current++<state.selectedQuestions-1?showQuestion:endGame)())}async function endGame(){console.log("Starting endGame, answers:",state.answers.length,"questions:",state.selectedQuestions);trackEvent("game_complete","performance",`${state.answers.filter(e=>e.correct).length}/${state.selectedQuestions} correct`,state.score);var t=els.game(),s=els.summary(),a=els.highscores();if(t&&s&&a){t.classList.add("hidden"),s.classList.add("active"),a.classList.remove("hidden"),document.querySelector(".app-footer")?.classList.remove("hidden"),clearInterval(state.timerId),stopAllSounds();var o=state.questions[0]?.category||"general knowledge";let e=null;try{var i=await db.collection("scores").where("category","==",o).orderBy("score","desc").limit(1).get();e=i.empty?null:i.docs[0].data()}catch(e){console.error("endGame: Error fetching global high score:",e)}try{await saveHighScore()}catch(e){console.error("endGame: Error in saveHighScore:",e),showError("Failed to save high score. Please try again.")}try{await showSummary(e)}catch(e){console.error("endGame: Error in showSummary:",e)}state.questions=[],state.current=0,state.score=0,state.answers=[],state.isScoreSaved=!1,state.isNextPending=!1,SPECIAL_QUIZ_TYPES.includes(o)?(i=document.querySelector(".action-buttons"))&&(i.innerHTML=`
                <div class="progress-message">
                    <p>You've completed today's ${toInitCaps(o)} challenge!</p>
                    <p>New questions in <span id="daily-reset-timer"></span></p>
                    <button id="upgrade-btn" class="btn primary">Try Regular Quiz</button>
                    <a href="/" class="btn"><span class="material-icons">home</span> Back Home</a>
                </div>`,(i=document.getElementById("upgrade-btn"))&&i.addEventListener("click",()=>{state.isTimedMode=!1,state.selectedQuestions=10,localStorage.removeItem("triviaMasterTimedMode"),localStorage.removeItem("triviaMasterTimerDuration"),initTriviaGame("general knowledge")}),updateDailyResetTimer(),setInterval(updateDailyResetTimer,1e3)):(o=document.querySelector(".action-buttons"))&&(o.innerHTML=`
                <button class="btn primary" id="restart-btn">
                    <span class="material-icons">replay</span>Play Again
                </button>
                <a href="/" class="btn"><span class="material-icons">home</span> Back Home</a>`,i=document.getElementById("restart-btn"))&&i.addEventListener("click",restartGame)}else console.error("DOM elements missing:",{gameScreen:!!t,summaryScreen:!!s,highscores:!!a})}function updateDailyResetTimer(){var e=new Date,t=new Date,t=(t.setHours(24,0,0,0),t-e),e=Math.floor(t/36e5),t=Math.floor(t%36e5/6e4),s=document.getElementById("daily-reset-timer");s&&(s.textContent=e+`h ${t}m`)}function showSettingsPanel(e){var t=document.getElementById("settings-panel"),s=document.getElementById("timed-mode"),a=document.getElementById("mode-label"),o=document.getElementById("timer-duration"),i=document.getElementById("difficulty-level"),n=document.getElementById("remember-settings");t&&s&&a&&o&&i&&n&&(s.checked=state.isTimedMode,a.textContent=state.isTimedMode?"Timed":"Non-Timed",o.value=state.timerDuration,o.parentElement.style.display=state.isTimedMode?"flex":"none",i.value=state.difficulty||"mixed",n.checked=state.rememberSettings,t.classList.remove("hidden"),s=document.getElementById("close-settings-btn"),e&&s?(s.disabled=!0,s.style.opacity="0.5",s.style.cursor="not-allowed"):s&&(s.disabled=!1,s.style.opacity="1",s.style.cursor="pointer"))}function startGameWithSettings(e){fetchQuestions(e).then(e=>{state.questions=e,preFetchImages(e).then(()=>{showQuestion()}).catch(e=>{console.error("Error pre-fetching images:",e),showQuestion()})}).catch(e=>{console.error("Error fetching questions:",e),showError(e.message||"Failed to load questions.")})}function restartGame(){trackEvent("restart_game","navigation","from_summary"),state.usedQuestions.clear(),state.questions=[],state.current=0,state.score=0,state.answers=[],updateTimerUI(),els.score().textContent="0",els.game().classList.remove("hidden"),els.game().classList.add("active"),els.summary().classList.remove("active"),els.highscores().classList.add("hidden"),localStorage.removeItem(CACHE.QUESTIONS),initTriviaGame(state.category)}async function showSummary(e){console.log("showSummary: state.answers:",state.answers),console.log("showSummary: state.answers.length:",state.answers.length),console.log("showSummary: correctCount:",state.answers.filter(e=>e.correct).length);var t=state.isTimedMode?state.selectedQuestions*timers[state.timerDuration]-state.timeLeft:0,s=state.answers.filter(e=>e.correct).length,a=state.questions[0]?.category||"general knowledge";let o,i;i=0===s?o="zero":s>=.9*state.selectedQuestions?o="gold":s>=.7*state.selectedQuestions?o="silver":o="bronze";var n,r,l=messages[o][Math.floor(Math.random()*messages[o].length)],c=els.highscoresList();c?((n=document.querySelector(".performance-message"))&&n.classList.add(i),c.innerHTML='<div class="loading-indicator"><div class="loading-spinner"></div><p>Loading high scores...</p></div>',n=els.correctCount(),c=els.timeUsed(),r=els.resultMessage(),n&&c&&r?(n.textContent=s+"/"+state.selectedQuestions,c.textContent=state.isTimedMode?`${Math.floor(t/60)}m ${(t%60).toString().padStart(2,"0")}s`:"N/A",r.innerHTML=l,e&&r.insertAdjacentHTML("afterend",`
            <div class="global-high-score">
                <div class="global-high-details">
                    <div class="global-high-text"> üèÜ Global High in ${toInitCaps(a)}: ${e.score} by ${e.name}</div>
                </div>
            </div>
            ${e.score>state.score?`<div class="motivation-text">You're ${e.score-state.score} points behind the leader!</div>`:'<div class="global-champion-message">üéâ You beat the global high score! Submit your score to claim the crown!</div>'}
        `),document.getElementById("total-score").textContent=state.score,els.highscoresList().innerHTML=state.highScores.length?state.highScores.map((e,t)=>`
            <div class="highscore-entry compact">
                <span class="name">${t+1}. ${e.name}</span>
                <span class="score">${e.score}</span>
            </div>
        `).join(""):'<p class="no-scores">No high scores yet</p>',await updateHighScores()):console.error("Summary elements missing:",{correctCount:!!n,timeUsed:!!c,resultMessage:!!r})):console.error("Highscores list (#highscores-list) not found in DOM")}async function saveHighScore(){if(state.isScoreSaved||!state.score)console.log("saveHighScore: Skipped - isScoreSaved:",state.isScoreSaved,"score:",state.score);else{var e=CATEGORY_ALIASES[state.questions[0]?.category]||state.questions[0]?.category||"general knowledge",s=prompt("Enter your name:","Anonymous")||"Anonymous";console.log("saveHighScore: Saving score:",{name:s,score:state.score,category:e,difficulty:state.difficulty,timestamp:firebase.firestore.Timestamp.now()});let t=2;for(;0<t;)try{return await db.collection("scores").add({name:s,score:state.score,category:e,difficulty:state.difficulty,timestamp:firebase.firestore.Timestamp.now()}),state.isScoreSaved=!0,void console.log("saveHighScore: Score saved successfully")}catch(e){console.error("saveHighScore: Error saving score (attempt "+(3-t)+"):",e),0===--t&&showError("Failed to save high score after retries. Please try again.")}}}async function updateHighScores(){var t=els.highscoresList();if(t){var e=CATEGORY_ALIASES[state.questions[0]?.category]||state.questions[0]?.category||"general knowledge";try{var s=await db.collection("scores").where("category","==",e).where("difficulty","==",state.difficulty).orderBy("score","desc").limit(5).get();state.highScores=s.docs.map(e=>e.data()),t.innerHTML=state.highScores.length?state.highScores.map((e,t)=>`
                <div class="highscore-entry">
                    <span class="rank">${t+1}.</span>
                    <span class="name">${e.name}</span>
                    <span class="score">${e.score}</span>
                </div>
            `).join(""):'<p class="no-scores">No high scores yet for this category. Play a game to start!</p>'}catch(e){console.error("updateHighScores: Error fetching global high scores:",e),t.innerHTML='<p class="no-scores">Error loading high scores. Please try again later.</p>'}}}function setupEvents(){var e=document.getElementById("next-btn");e&&e.addEventListener("click",handleNextQuestion);let t=document.getElementById("mute-btn");t&&t.addEventListener("click",()=>{state.isMuted=!state.isMuted,localStorage.setItem("triviaMasterMuteState",state.isMuted);var e=t.querySelector(".material-icons");e&&(e.textContent=state.isMuted?"volume_off":"volume_up"),state.isMuted?stopAllSounds():els.game().classList.contains("active")&&state.isTimedMode&&playSound("tick")});e=document.getElementById("settings-btn");let o=document.getElementById("settings-panel"),i=document.getElementById("timed-mode"),s=document.getElementById("mode-label");var a=document.getElementById("save-settings-btn"),n=document.getElementById("close-settings-btn");let r=document.getElementById("timer-duration"),l=document.getElementById("difficulty-level");a&&a.addEventListener("click",()=>{var e=i?i.checked:state.isTimedMode,t=r?r.value:state.timerDuration,s=l?l.value:state.difficulty,a=document.getElementById("remember-settings")?.checked||!1;state.isTimedMode=e,state.timerDuration=t,state.difficulty=s,state.rememberSettings=a,localStorage.setItem("triviaMasterTimedMode",state.isTimedMode),localStorage.setItem("triviaMasterTimerDuration",state.timerDuration),localStorage.setItem("triviaMasterDifficulty",state.difficulty),localStorage.setItem("triviaMasterRememberSettings",state.rememberSettings),updateDifficultyDisplay(),toggleClass(o,"add","hidden"),state.showSettingsOnStart?(state.showSettingsOnStart=!1,startGameWithSettings(state.category)):(state.current=0,updateTimerUI(),showQuestion())}),e&&o&&e.addEventListener("click",()=>{toggleClass(o,"remove","hidden"),i&&(i.checked=state.isTimedMode),s&&(s.textContent=state.isTimedMode?"Timed":"Non-Timed"),r&&(r.value=state.timerDuration,r.parentElement.style.display=state.isTimedMode?"flex":"none"),l&&(l.value=state.difficulty)}),i&&i.addEventListener("change",()=>{s.textContent=i.checked?"Timed":"Non-Timed",r&&(r.parentElement.style.display=i.checked?"flex":"none")}),a&&a.addEventListener("click",()=>{var e=i?i.checked:state.isTimedMode,t=r?r.value:state.timerDuration,s=l?l.value:state.difficulty;e===state.isTimedMode&&t===state.timerDuration&&s===state.difficulty||(state.isTimedMode=e,state.timerDuration=t,state.difficulty=s,localStorage.setItem("triviaMasterTimedMode",state.isTimedMode),localStorage.setItem("triviaMasterTimerDuration",state.timerDuration),localStorage.setItem("triviaMasterDifficulty",state.difficulty),state.current=0,updateTimerUI(),showQuestion()),toggleClass(o,"add","hidden")}),n&&n.addEventListener("click",()=>{toggleClass(o,"add","hidden")}),window.addEventListener("beforeunload",()=>{clearInterval(state.timerId),stopAllSounds()})}function setupStartQuizListener(){document.addEventListener("startQuiz",e=>{var{category:e,isTimedMode:t}=e.detail;state.isTimedMode=t,initTriviaGame(e)})}document.addEventListener("DOMContentLoaded",()=>{var e;setupStartQuizListener(),loadMuteState(),window.location.pathname.includes("catalog.html")||initTriviaGame(1<(e=window.location.pathname.split("/").filter(e=>e)).length?e[1].replace(/-/g," "):"general knowledge")}),window.triviaGame={endGame:endGame};export{initTriviaGame};
