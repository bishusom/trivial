function initWordGame(){let u={gridCols:12,gridRows:8,minWordLength:4,maxWordLength:8,wordCount:{easy:6,medium:8,hard:10},maxPlacementAttempts:200,maxTotalAttempts:1e3,maxRetries:3},f=[],g=[],w=[],m=[],o=!1,p="easy",v=0,E=1,C=new Set,t=0,y={horizontal:0,vertical:0,diagonal:0},L=document.getElementById("wordsearch-grid"),T=document.getElementById("wordsearch-wordlist"),e=document.getElementById("wordsearch-words-left"),r=document.getElementById("wordsearch-feedback");var l=document.getElementById("wordsearch-new"),n=document.getElementById("wordsearch-hint");let a=document.createElement("span"),d=(a.id="wordsearch-level",document.createElement("span"));d.id="wordsearch-games-remaining",r||((r=document.createElement("div")).id="wordsearch-feedback",r.className="word-feedback",document.querySelector(".game-body").appendChild(r));var s=document.querySelector(".word-game-meta");async function S(){L.innerHTML="",T.innerHTML="",m=[],w=[],o=!1,C.clear(),y={horizontal:0,vertical:0,diagonal:0};var e=(()=>{var e=localStorage.getItem("wordGameState");if(e)try{return JSON.parse(e)}catch(e){console.error("Failed to parse saved game state",e)}return null})();E=e?(p=e.difficulty||"easy",v=e.consecutiveWins||0,e.currentLevel||1):(p="easy",v=0,1);try{(g=await R(u)).sort((e,t)=>t.letters.length-e.letters.length),console.log("Words fetched and sorted:",g);let o=!1,l=0;for(;!o&&l<3;){l++,console.log(`Attempt ${l} to place all words`),f=Array(u.gridCols*u.gridRows).fill().map(()=>({letter:"",element:null,word:null}));let e=[],t=0,r=[...g];for(var n=u.wordCount[p],a=Math.floor(n/3),d={horizontal:a,vertical:a,diagonal:n-2*a};e.length<u.wordCount[p]&&t<u.maxTotalAttempts;){0===r.length&&(r=[...g].filter(t=>!e.some(e=>e.word===t.word)),console.log("Resetting available words:",r));var s=r[0];M(s,d)?(e.push(s),C.add(s.word),r.shift(),console.log(`Placed word: ${s.word}, Total placed: `+e.length)):(r.shift(),console.log(`Failed to place word: ${s.word}, Moving to next word`),t++)}if((g=e).length<u.wordCount[p]){console.warn(`Only placed ${g.length} out of ${u.wordCount[p]} words`);var i=u.wordCount[p]-g.length,c=(await R(u,i)).filter(e=>!C.has(e.word));let e=0;for(;g.length<u.wordCount[p]&&e<u.maxTotalAttempts&&0<c.length;){var h=c[0];M(h,d)?(g.push(h),C.add(h.word),c.shift(),console.log(`Simpler placement: Placed word: ${h.word}, Total placed: `+g.length)):(c.shift(),e++,console.log("Simpler placement failed for: "+h.word))}}g.length===u.wordCount[p]?o=!0:(console.warn("Failed to place all words on attempt "+l),C.clear(),(g=await R(u)).sort((e,t)=>t.letters.length-e.letters.length),y={horizontal:0,vertical:0,diagonal:0})}if(!o)throw new Error(`Could only place ${g.length} out of ${u.wordCount[p]} words after 3 attempts`);{let r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";f.forEach((e,t)=>{""===e.letter&&(e.letter=r[Math.floor(Math.random()*r.length)])}),console.log("Grid after filling empty cells:",f)}console.log(`Rendering grid with ${u.gridCols} cols and ${u.gridRows} rows`),L.style.setProperty("--cols",u.gridCols),L.style.setProperty("--rows",u.gridRows),L.style.display="grid",L.style.width="100%",L.style.maxWidth="100%",L.style.overflow="hidden",L.innerHTML="",f.forEach((e,t)=>{var r=document.createElement("div");r.className="wordsearch-cell",r.textContent=e.letter,r.dataset.index=t,r.addEventListener("mousedown",D),r.addEventListener("mouseenter",e=>{e.preventDefault(),x(e)}),r.addEventListener("mouseup",U),r.addEventListener("touchstart",b,{passive:!1}),r.addEventListener("touchmove",P,{passive:!1}),r.addEventListener("touchend",$),L.appendChild(r),e.element=r}),T.innerHTML="",g.forEach(e=>{var t=document.createElement("div");t.className="wordsearch-word",t.textContent=e.word,t.dataset.word=e.word,T.appendChild(t)}),N(),A(),O(`Find ${g.length} hidden words!`,"info"),t=0}catch(e){if(console.error("Game initialization failed:",e),O("Failed to load puzzle. Retrying...","error"),++t>=u.maxRetries)return void O("Failed to load puzzle after multiple attempts. Please refresh the page.","error");setTimeout(()=>{var e=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=u.minWordLength&&e.length<=u.maxWordLength),e=[...new Set(e)].filter(e=>!C.has(e));(g=I(e).slice(0,u.wordCount[p]).map(e=>({word:e,letters:e.split("")}))).sort((e,t)=>t.letters.length-e.letters.length),S()},2e3)}"undefined"!=typeof gtag&&gtag("event","word_search_started",{event_category:"word_search",event_label:1,value:void 0})}async function R({minWordLength:o,maxWordLength:l,wordCount:n},a=null){try{var d=Math.floor(9e5*Math.random()),s=a||3*n[p],e=await db.collection("dictionary").where("length",">=",o).where("length","<=",l).where("randomIndex",">=",d).orderBy("randomIndex").limit(s).get();if(e.empty)throw new Error("No words found in dictionary");let t=new Set,r=[];if(e.forEach(e=>{var e=e.data();e.word&&e.letters&&(e=e.word.toUpperCase(),C.has(e)||(t.add(e),r.push({word:e,letters:e.split("").map(e=>e.toUpperCase())})))}),0===t.size)throw new Error("No valid words found");var i=I(r).slice(0,a||n[p]);return console.log("Generated word list:",i),i}catch(e){console.error("Error fetching words:",e);d=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=o&&e.length<=l),s=I([...new Set(d)].filter(e=>!C.has(e))).slice(0,a||n[p]).map(e=>({word:e,letters:e.split("")}));return console.log("Fallback word list:",s),s}}function M(t,r){var o,e=[{id:0,type:"horizontal",rowStep:0,colStep:1},{id:1,type:"vertical",rowStep:1,colStep:0},{id:2,type:"diagonal",rowStep:1,colStep:1},{id:3,type:"diagonal",rowStep:-1,colStep:1}],l=e.filter(e=>!("horizontal"===e.type&&y.horizontal>=r.horizontal||"vertical"===e.type&&y.vertical>=r.vertical||"diagonal"===e.type&&y.diagonal>=r.diagonal));for(o of I([...0<l.length?l:e]))for(let e=0;e<50;e++){var n=0===o.rowStep?u.gridRows:u.gridRows-t.letters.length*Math.abs(o.rowStep),a=0===o.colStep?u.gridCols:u.gridCols-t.letters.length*Math.abs(o.colStep),n=Math.floor(Math.random()*n),a=Math.floor(Math.random()*a);if(((e,o,l,n)=>{var a=e.letters;for(let r=0;r<a.length;r++){let e=o,t=l;switch(n){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}if(e<0||e>=u.gridRows||t<0||t>=u.gridCols)return;var d=e*u.gridCols+t;if(""!==f[d].letter&&f[d].letter!==a[r])return}return 1})(t,n,a,o.id)){w=g=h=c=i=s=d=void 0;var d=t,s=n,i=a,c=o.id,{word:h,letters:g}=d;for(let r=0;r<g.length;r++){let e=s,t=i;switch(c){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}var w=e*u.gridCols+t;f[w].letter=g[r],f[w].word=h}return"horizontal"===o.type?y.horizontal++:"vertical"===o.type?y.vertical++:"diagonal"===o.type&&y.diagonal++,console.log(`Placed ${t.word} in ${o.type} direction at (${n}, ${a})`),1}}console.log(`Failed to place ${t.word} after trying all directions`)}function i(){if(!(m.length<u.minWordLength)){var e=m.map(e=>f[e].letter).join(""),l=e.split("").reverse().join("");let t=e.toUpperCase(),r=l.toUpperCase(),o=g.find(e=>e.word.toUpperCase()===t||e.word.toUpperCase()===r);o&&!w.includes(o.word)?(w.push(o.word),m.forEach(e=>{f[e].element.classList.remove("selected"),f[e].element.classList.add("found")}),T.querySelectorAll(".wordsearch-word").forEach(e=>{e.dataset.word===o.word&&e.classList.add("found")}),N(),O("Found: "+o.word,"success"),w.length===g.length&&(3<=++v?("easy"===p?(p="medium",O("Advanced to Medium level!","success")):"medium"===p?(p="hard",O("Advanced to Hard level!","success")):O("Mastered all levels!","success"),v=0,E++):O(`Great job! ${3-v} more wins to advance.`,"info"),A(),e={difficulty:p,consecutiveWins:v,currentLevel:E},localStorage.setItem("wordGameState",JSON.stringify(e)),setTimeout(S,2e3))):O("Word not found in list","error")}m=[],h()}function A(){a.textContent=`Level: ${E} (${p})`,d.textContent="Wins to next level: "+(3-v)}function N(){e.textContent=`Words: ${g.length-w.length}/`+g.length}function O(e,t){r.textContent=e,r.className="word-feedback "+t}function I(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}function D(e){e.preventDefault(),o=!0;e=c(e.target);null!==e&&(m=[e],h())}function x(e){var t,r;e.preventDefault(),!o||0===m.length||null===(e=c(e.target))||m.includes(e)||(t=m[m.length-1],r=(()=>{if(!(m.length<2)){var e=m[0],t=m[1],r=Math.floor(e/u.gridCols),e=e%u.gridCols,o=Math.floor(t/u.gridCols),t=t%u.gridCols,o=o-r,r=t-e;if(0==o&&0!=r)return{row:0,col:0<r?1:-1};if(0==r&&0!=o)return{row:0<o?1:-1,col:0};if(Math.abs(o)===Math.abs(r))return{row:0<o?1:-1,col:0<r?1:-1}}return null})(),1<m.length&&!((e,t,r)=>{var o,l;if(r)return l=Math.floor(e/u.gridCols),e%=u.gridCols,o=Math.floor(t/u.gridCols),t%=u.gridCols,o-=l,l=t-e,0===r.row?0==o&&l===r.col:0===r.col?0==l&&o===r.row:Math.sign(o)===Math.sign(r.row)&&Math.sign(l)===Math.sign(r.col)&&Math.abs(o)===Math.abs(l)})(t,e,r))||(m.push(e),h())}function U(){o&&(o=!1,i())}function c(e){return e.classList.contains("wordsearch-cell")?parseInt(e.dataset.index):null}function h(){f.forEach(e=>{e.element.classList.remove("selected")}),m.forEach(e=>{f[e].element.classList.add("selected")})}function b(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&D({target:e,preventDefault:()=>{}})}function P(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&x({target:e,preventDefault:()=>{}})}function $(e){e.preventDefault(),U()}s&&(s.appendChild(a),s.appendChild(d)),S(),l.addEventListener("click",S),n.addEventListener("click",function(){var e=g.filter(e=>!w.includes(e.word));0<e.length?O(`Try looking for a word starting with ${e[Math.floor(Math.random()*e.length)].word.slice(0,2)}...`,"info"):O("You found all words!","success")})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
