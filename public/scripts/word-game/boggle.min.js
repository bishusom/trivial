function initWordGame(){var e=(()=>{var e=localStorage.getItem("boggleGameState");if(e)try{var t=JSON.parse(e);if(["easy","medium","hard"].includes(t.difficulty)&&"number"==typeof t.consecutiveWins&&"number"==typeof t.currentLevel)return t}catch(e){console.error("Invalid saved game state",e)}return null})();let u=e?.difficulty||"easy",a=e?.consecutiveWins||0,g=e?.currentLevel||1,h=0,n=180,m=null,f=[],p={gridSize:{easy:4,medium:5,hard:5},minWordLength:3,maxWordLength:4,timeLimit:180,scorePerLetter:10,winThreshold:{easy:50,medium:100,hard:120},vowelPercentage:{easy:.4,medium:.35,hard:.35}},P=["CAT","DOG","HAT","RUN","SUN","PEN","RED","BLUE","TREE","BIRD","FISH","STAR","MOON","PLAY","BOOK","FOOD","GOOD","LOVE","HOME","TIME","BALL","GAME","CARS","SHIP","WIND","RAIN","SNOW","FIRE","WAVE","HILL"].map(e=>e.toUpperCase()),v=[],y=new Set,L=[],o=!1,E=new Set,w=new Map,l=0,M=document.getElementById("boggle-grid"),r=document.getElementById("boggle-word-list"),i=document.getElementById("boggle-feedback");var e=document.getElementById("boggle-new"),t=document.getElementById("boggle-hint");let A=document.getElementById("boggle-time"),F=document.getElementById("boggle-score"),G=document.getElementById("boggle-level");function S(e,t,n,r){"undefined"!=typeof gtag&&gtag("event",e,{event_category:t,event_label:n,value:r})}function s(){var e={difficulty:u,consecutiveWins:a,currentLevel:g};localStorage.setItem("boggleGameState",JSON.stringify(e))}async function d(){console.log("Initializing Boggle game with state:",{difficulty:u,currentLevel:g,consecutiveWins:a});try{var t=Math.floor(1e4*Math.random());let e=(await db.collection("dictionary").where("length",">=",p.minWordLength).where("length","<=",p.maxWordLength).where("randomIndex",">=",t).orderBy("randomIndex").limit(50).get()).docs.map(e=>e.data().word.toUpperCase());console.log(`Fetched ${e.length} words from Firebase`)}catch(e){console.error("Error fetching words from Firebase:",e),f=["CAT","DOG","HAT","RUN","SUN","PEN","RED","BLUE","TREE","BIRD","FISH","STAR","MOON","PLAY","BOOK","FOOD","GOOD","LOVE","HOME","TIME"].map(e=>e.toUpperCase())}await 0;var e,t=document.querySelector(".selection-line");t&&t.remove(),clearInterval(m),n=p.timeLimit,h=0,y.clear(),L=[],o=!1,E.clear(),w.clear(),M.innerHTML="",R(r.innerHTML="","info"),I(),T(),b(),clearInterval(m),m=setInterval(()=>{n--,b()},1e3);try{{let t=p.gridSize[u],n="AEIOU",r=Math.ceil(t*t*p.vowelPercentage[u]),o=0,a=(v=[],[]);f.forEach(e=>{e.split("").forEach(e=>a.push(e))}),["S","T","B","C","D","F","G","H","L","M","N","P","R"].forEach(e=>a.push(e)),["TH","CH","SH","QU","BR","CR","DR","FR","GR","PR","TR"].forEach(e=>{a.push(e[0]),a.push(e[1])});for(let e=0;e<30;e++)a.push(n[Math.floor(Math.random()*n.length)]);var l="hard"===u?"JQXZ":"JQX";for(let e=0;e<40;e++){var i=Math.random()<.8?"BCDFGHKLMNPRSTVWY":l;a.push(i[Math.floor(Math.random()*i.length)])}let e=0;for(;e<5;){v=[];for(let e=o=0;e<t*t;e++){var s=Math.floor(e/t),d=e%t;(0<s&&s<t-1&&0<d&&d<t-1||o<r)&&(o<r||Math.random()<.6)?(s=n[Math.floor(Math.random()*n.length)],v.push({letter:s,element:null}),o++):(d=Math.floor(Math.random()*a.length),v.push({letter:a[d],element:null}))}if("hard"!==u||(()=>{let t=v.map(e=>e.letter).join(""),e=["STR","THR","SPL","SPR","SCR","SHR","PHL","CHR"].filter(e=>t.includes(e)).length,r=0,o=p.gridSize[u];for(let n=0;n<v.length;n++){var a,l=Math.floor(n/o),i=n%o;if("AEIOU".includes(v[n].letter))for(let t=l-1;t<=l+1;t++)for(let e=i-1;e<=1+i;e++)0<=t&&t<o&&0<=e&&e<o&&(a=t*o+e)!==n&&"AEIOU".includes(v[a].letter)&&r++}return 3<=e&&r<=2*o})())break;e++}var c=v.filter(e=>n.includes(e.letter)).length;console.log(`Generated ${t}x${t} grid with ${c} vowels`),v}e=p.gridSize[u],M.style.gridTemplateColumns=`repeat(${e}, 1fr)`,M.style.gridTemplateRows=`repeat(${e}, 1fr)`,M.style.setProperty("--grid-size",e),M.style.display="grid",M.style.width="100%",M.style.maxWidth="100%",M.style.overflow="hidden",v.forEach((e,t)=>{var n=document.createElement("div");n.className="boggle-cell",n.textContent=e.letter,n.dataset.index=t,n.addEventListener("mousedown",$),n.addEventListener("mouseenter",O),n.addEventListener("mouseup",N),n.addEventListener("touchstart",U,{passive:!1}),n.addEventListener("touchmove",k,{passive:!1}),n.addEventListener("touchend",j),M.appendChild(n),e.element=n}),S("boggle_game_started","boggle","start",1)}catch(e){console.error("Game initialization failed:",e),R("Failed to load puzzle. Please refresh the page.","error")}}function c(e){var e=v[e].element.getBoundingClientRect(),t=M.getBoundingClientRect();return{x:e.left+e.width/2-t.left,y:e.top+e.height/2-t.top}}async function z(){if(L.length<p.minWordLength)R("Word too short","error");else{var t,n=L.map(e=>v[e].letter).join("");if(y.has(n))R("Word already found","error");else try{let e=!1;if(w.has(n.toLowerCase())?e=w.get(n.toLowerCase()):(t=await fetch("https://api.dictionaryapi.dev/api/v2/entries/en/"+n.toLowerCase()),e=t.ok,w.set(n.toLowerCase(),e)),e&&n.length>=p.minWordLength&&n.length<=p.maxWordLength){y.add(n);var r=n.length*p.scorePerLetter;if(h+=r,L.forEach(e=>v[e].element.classList.add("found")),C(),I(),R(`Found: ${n} (+${r} points)`,"success"),S("word_found","boggle",n,r),h>=p.winThreshold[u]){clearInterval(m);let e=document.createElement("div"),t=(e.className="victory-screen",x(),a++,""),n=(3<=a?("easy"===u?(u="medium",t="ðŸŽ‰ Advanced to Medium level! ðŸŽ‰",setTimeout(()=>x({particleCount:200,spread:100}),1e3)):"medium"===u?(u="hard",t="ðŸ† Advanced to Hard level! ðŸ†",setTimeout(()=>x({particleCount:300,spread:120,shapes:["circle","square"]}),1e3)):(t="ðŸ‘‘ Mastered all levels! ðŸ‘‘",setTimeout(()=>x({particleCount:400,spread:150,shapes:["circle","square","star"]}),1e3),setTimeout(()=>x({particleCount:400,spread:150,origin:{x:0}}),1500),setTimeout(()=>x({particleCount:400,spread:150,origin:{x:1}}),2e3)),a=0,g++):t=`ðŸŽŠ Great job! ${3-a} more wins to advance. ðŸŽŠ`,e.innerHTML=`
      <h2>Victory!</h2>
      <p>${t}</p>
      <p>Score: ${h}</p>
      <p>Words Found: ${y.size}</p>
      <div class="countdown">Next game starting in 5...</div>
    `,document.body.appendChild(e),5),r=e.querySelector(".countdown"),o=setInterval(()=>{n--,r.textContent=`Next game starting in ${n}...`,n<=0&&(clearInterval(o),e.remove(),s(),T(),d())},1e3);S("level_complete","boggle",u,h),s(),T(),setTimeout(d,3600)}}else R("Not a valid word","error")}catch(e){console.error("Error checking word:",e),P.includes(n.toUpperCase())?(y.add(n),t=n.length*p.scorePerLetter,h+=t,L.forEach(e=>v[e].element.classList.add("found")),C(),I(),R(`Found: ${n} (+${t} points)`,"success"),S("word_found","boggle",n,t)):R("Error checking word, try another","error")}}L=[],B()}function C(){r.innerHTML="",Array.from(y).sort().forEach(e=>{var t=document.createElement("li");t.textContent=e,r.appendChild(t)})}function I(){F.textContent="Score: "+h}function T(){G.textContent=`Level: ${g} (${u})`}function b(){var e=Math.floor(n/60),t=n%60;A.textContent=`Time: ${e}:`+t.toString().padStart(2,"0"),n<=0&&(clearInterval(m),R("Timeâ€™s up!","error"),setTimeout(d,2e3))}function x(e={}){let t={particleCount:100,spread:70,origin:{y:.6},colors:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"]};confetti({...t,...e}),.5<Math.random()&&setTimeout(()=>{confetti({...t,...e,angle:180*Math.random()-90,origin:{x:Math.random(),y:.6}})},300)}function R(e,t){i.textContent=e,i.className="word-feedback "+t}function $(e){e.preventDefault(),o=!0;e=D(e.target);null!==e&&(L=[e],E=new Set([e]),B(),H(e),console.log(`Selection started at index ${e} (${v[e].letter}) at (${Math.floor(e/5)}, ${e%5})`))}function O(e){var t,n,r;e.preventDefault(),!o||0===L.length||(t=Date.now())-l<20||(l=t,null===(t=D(e.target)))||E.has(t)||(e=L[L.length-1],n=p.gridSize[u],console.log(`Checking adjacency between: 
      ${e} (${v[e].letter}) at (${Math.floor(e/n)},${e%n}) and 
      ${t} (${v[t].letter}) at (${Math.floor(t/n)},${t%n})`),n=t,e=W(e=e),n=W(n),r=Math.abs(n.row-e.row),n=Math.abs(n.col-e.col),r<=1&&n<=1&&(0!==r||0!==n)?(L.push(t),E.add(t),B(),H(t)):console.log("Not adjacent - row/col diff too large"))}function N(){var e;o&&(o=!1,v.forEach(e=>e.element.classList.remove("adjacent")),(e=document.querySelector(".selection-line"))&&e.remove(),(L.length<2?(R("Selection too short, please select at least 2 letters","error"),L=[],B):z)())}function H(e){v.forEach(e=>e.element.classList.remove("adjacent"));var n,r=p.gridSize[u],o=Math.floor(e/r),a=e%r;for(let t=o-1;t<=o+1;t++)for(let e=a-1;e<=1+a;e++)t===o&&e===a||t<0||t>=r||e<0||e>=r||(n=t*r+e,E.has(n))||v[n].element.classList.add("adjacent")}function D(e){return e.classList.contains("boggle-cell")?parseInt(e.dataset.index):null}function W(e){var t=p.gridSize[u];return{row:Math.floor(e/t),col:e%t}}function B(){v.forEach(e=>{e.element.classList.remove("selected","highlight")}),L.forEach(e=>{v[e].element&&(v[e].element.classList.add("selected"),e===L[L.length-1])&&v[e].element.classList.add("highlight")});var e=document.querySelector(".selection-line");if(e&&e.remove(),!(L.length<2)){e=document.createElement("div");e.className="selection-line",M.appendChild(e);for(let e=0;e<L.length-1;e++){var t=c(L[e]),n=c(L[e+1]),r=Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)),n=180*Math.atan2(n.y-t.y,n.x-t.x)/Math.PI,o=document.createElement("div");o.className="selection-line",o.style.width=r+"px",o.style.left=t.x+"px",o.style.top=t.y+"px",o.style.transform=`rotate(${n}deg)`,M.appendChild(o)}}}function U(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("boggle-cell")&&$({target:e,preventDefault:()=>{}})}function k(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("boggle-cell")&&O({target:e,preventDefault:()=>{}})}function j(e){e.preventDefault(),N()}d(),e.addEventListener("click",d),t.addEventListener("click",async function(){var e;0<y.size?R("Try finding more words first!","info"):(R("Looking for a hint...","info"),(e=await findValidWordHint())?(R("Hint: Try finding a word starting with "+e[0],"success"),S("hint_used","boggle",u,g)):R("No hints available","error"))})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
