function initWordGame(){var e=(()=>{var e=localStorage.getItem("wordGameState");if(e)try{var t=JSON.parse(e);if(["easy","medium","hard"].includes(t.difficulty)&&"number"==typeof t.consecutiveWins&&"number"==typeof t.currentLevel)return t}catch(e){console.error("Invalid saved game state",e)}return null})();let g=e?.difficulty||"easy",u=e?.consecutiveWins||0,w=e?.currentLevel||1,f={gridCols:12,gridRows:8,minWordLength:4,maxWordLength:8,wordCount:{easy:6,medium:8,hard:10},maxPlacementAttempts:200,maxTotalAttempts:1e3,maxRetries:3},m=[],p=[],v=[],E=[],o=!1,C=new Set,t=0,y={horizontal:0,vertical:0,diagonal:0},L=document.getElementById("wordsearch-grid"),T=document.getElementById("wordsearch-wordlist"),r=document.getElementById("wordsearch-words-left"),l=document.getElementById("wordsearch-feedback");var e=document.getElementById("wordsearch-new"),n=document.getElementById("wordsearch-hint");let a=document.createElement("span"),d=(a.id="wordsearch-level",document.createElement("span"));d.id="wordsearch-games-remaining",l||((l=document.createElement("div")).id="wordsearch-feedback",l.className="word-feedback",document.querySelector(".game-body").appendChild(l));var i=document.querySelector(".word-game-meta");async function R(){console.log("Initializing game with state:",{difficulty:g,currentLevel:w,consecutiveWins:u}),I("","info"),L.innerHTML="",T.innerHTML="",E=[],v=[],o=!1,C.clear(),y={horizontal:0,vertical:0,diagonal:0};try{(p=await S(f)).sort((e,t)=>t.letters.length-e.letters.length),console.log("Words fetched and sorted:",p);let o=!1,l=0;for(;!o&&l<3;){l++,console.log(`Attempt ${l} to place all words`),m=Array(f.gridCols*f.gridRows).fill().map(()=>({letter:"",element:null,word:null}));let e=[],t=0,r=[...p];for(var n=f.wordCount[g],a=Math.floor(n/3),d={horizontal:a,vertical:a,diagonal:n-2*a};e.length<f.wordCount[g]&&t<f.maxTotalAttempts;){0===r.length&&(r=[...p].filter(t=>!e.some(e=>e.word===t.word)),console.log("Resetting available words:",r));var i=r[0];M(i,d)?(e.push(i),C.add(i.word),r.shift(),console.log(`Placed word: ${i.word}, Total placed: `+e.length)):(r.shift(),console.log(`Failed to place word: ${i.word}, Moving to next word`),t++)}if((p=e).length<f.wordCount[g]){console.warn(`Only placed ${p.length} out of ${f.wordCount[g]} words`);var s=f.wordCount[g]-p.length,c=(await S(f,s)).filter(e=>!C.has(e.word));let e=0;for(;p.length<f.wordCount[g]&&e<f.maxTotalAttempts&&0<c.length;){var h=c[0];M(h,d)?(p.push(h),C.add(h.word),c.shift(),console.log(`Simpler placement: Placed word: ${h.word}, Total placed: `+p.length)):(c.shift(),e++,console.log("Simpler placement failed for: "+h.word))}}p.length===f.wordCount[g]?o=!0:(console.warn("Failed to place all words on attempt "+l),C.clear(),(p=await S(f)).sort((e,t)=>t.letters.length-e.letters.length),y={horizontal:0,vertical:0,diagonal:0})}if(!o)throw new Error(`Could only place ${p.length} out of ${f.wordCount[g]} words after 3 attempts`);{let r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";m.forEach((e,t)=>{""===e.letter&&(e.letter=r[Math.floor(Math.random()*r.length)])}),console.log("Grid after filling empty cells:",m)}console.log(`Rendering grid with ${f.gridCols} cols and ${f.gridRows} rows`),L.style.setProperty("--cols",f.gridCols),L.style.setProperty("--rows",f.gridRows),L.style.display="grid",L.style.width="100%",L.style.maxWidth="100%",L.style.overflow="hidden",L.innerHTML="",m.forEach((e,t)=>{var r=document.createElement("div");r.className="wordsearch-cell",r.textContent=e.letter,r.dataset.index=t,r.addEventListener("mousedown",D),r.addEventListener("mouseenter",e=>{e.preventDefault(),x(e)}),r.addEventListener("mouseup",b),r.addEventListener("touchstart",U,{passive:!1}),r.addEventListener("touchmove",P,{passive:!1}),r.addEventListener("touchend",$),L.appendChild(r),e.element=r}),T.innerHTML="",p.forEach(e=>{var t=document.createElement("div");t.className="wordsearch-word",t.textContent=e.word,t.dataset.word=e.word,T.appendChild(t)}),N(),A(),I(`Find ${p.length} hidden words!`,"info"),t=0}catch(e){if(console.error("Game initialization failed:",e),I("Failed to load puzzle. Retrying...","error"),++t>=f.maxRetries)return void I("Failed to load puzzle after multiple attempts. Please refresh the page.","error");setTimeout(()=>{var e=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=f.minWordLength&&e.length<=f.maxWordLength),e=[...new Set(e)].filter(e=>!C.has(e));(p=O(e).slice(0,f.wordCount[g]).map(e=>({word:e,letters:e.split("")}))).sort((e,t)=>t.letters.length-e.letters.length),R()},2e3)}"undefined"!=typeof gtag&&gtag("event","word_search_started",{event_category:"word_search",event_label:1,value:void 0})}async function S({minWordLength:o,maxWordLength:l,wordCount:n},a=null){try{var d=Math.floor(9e5*Math.random()),i=a||3*n[g],e=await db.collection("dictionary").where("length",">=",o).where("length","<=",l).where("randomIndex",">=",d).orderBy("randomIndex").limit(i).get();if(e.empty)throw new Error("No words found in dictionary");let t=new Set,r=[];if(e.forEach(e=>{var e=e.data();e.word&&e.letters&&(e=e.word.toUpperCase(),C.has(e)||(t.add(e),r.push({word:e,letters:e.split("").map(e=>e.toUpperCase())})))}),0===t.size)throw new Error("No valid words found");var s=O(r).slice(0,a||n[g]);return console.log("Generated word list:",s),s}catch(e){console.error("Error fetching words:",e);d=["FUNCTION","VARIABLE","OPERATOR","QUERY","JAVASCRIPT","REACT","ANGULAR","COMPONENT","MODULE","SCRIPT","CODING","DEBUG","ARRAY","LOOP","METHOD","CLASS","STRING","NUMBER","OBJECT","EVENT","STYLE","DESIGN","FORMAT","UPDATE","INSERT","DELETE","SELECT","TABLE","INDEX","FETCH","ROUTE","SERVER"].filter(e=>e.length>=o&&e.length<=l),i=O([...new Set(d)].filter(e=>!C.has(e))).slice(0,a||n[g]).map(e=>({word:e,letters:e.split("")}));return console.log("Fallback word list:",i),i}}function M(t,r){var o,e=[{id:0,type:"horizontal",rowStep:0,colStep:1},{id:1,type:"vertical",rowStep:1,colStep:0},{id:2,type:"diagonal",rowStep:1,colStep:1},{id:3,type:"diagonal",rowStep:-1,colStep:1}],l=e.filter(e=>!("horizontal"===e.type&&y.horizontal>=r.horizontal||"vertical"===e.type&&y.vertical>=r.vertical||"diagonal"===e.type&&y.diagonal>=r.diagonal));for(o of O([...0<l.length?l:e]))for(let e=0;e<50;e++){var n=0===o.rowStep?f.gridRows:f.gridRows-t.letters.length*Math.abs(o.rowStep),a=0===o.colStep?f.gridCols:f.gridCols-t.letters.length*Math.abs(o.colStep),n=Math.floor(Math.random()*n),a=Math.floor(Math.random()*a);if(((e,o,l,n)=>{var a=e.letters;for(let r=0;r<a.length;r++){let e=o,t=l;switch(n){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}if(e<0||e>=f.gridRows||t<0||t>=f.gridCols)return;var d=e*f.gridCols+t;if(""!==m[d].letter&&m[d].letter!==a[r])return}return 1})(t,n,a,o.id)){u=g=h=c=s=i=d=void 0;var d=t,i=n,s=a,c=o.id,{word:h,letters:g}=d;for(let r=0;r<g.length;r++){let e=i,t=s;switch(c){case 0:t+=r;break;case 1:e+=r;break;case 2:e+=r,t+=r;break;case 3:e-=r,t+=r}var u=e*f.gridCols+t;m[u].letter=g[r],m[u].word=h}return"horizontal"===o.type?y.horizontal++:"vertical"===o.type?y.vertical++:"diagonal"===o.type&&y.diagonal++,console.log(`Placed ${t.word} in ${o.type} direction at (${n}, ${a})`),1}}console.log(`Failed to place ${t.word} after trying all directions`)}function s(){if(!(E.length<f.minWordLength)){var e=E.map(e=>m[e].letter).join(""),l=e.split("").reverse().join("");let t=e.toUpperCase(),r=l.toUpperCase(),o=p.find(e=>e.word.toUpperCase()===t||e.word.toUpperCase()===r);o&&!v.includes(o.word)?(v.push(o.word),E.forEach(e=>{m[e].element.classList.remove("selected"),m[e].element.classList.add("found")}),T.querySelectorAll(".wordsearch-word").forEach(e=>{e.dataset.word===o.word&&e.classList.add("found")}),N(),I("Found: "+o.word,"success"),v.length===p.length&&(3<=++u?("easy"===g?(g="medium",I("Advanced to Medium level!","success")):"medium"===g?(g="hard",I("Advanced to Hard level!","success")):I("Mastered all levels!","success"),u=0,w++):I(`Great job! ${3-u} more wins to advance.`,"info"),A(),e={difficulty:g,consecutiveWins:u,currentLevel:w},localStorage.setItem("wordGameState",JSON.stringify(e)),setTimeout(R,2e3))):I("Word not found in list","error")}E=[],h()}function A(){var e;a.textContent=`Level: ${w} (${g})`,"hard"!==g?(e=3-u,d.textContent=0<e?"Wins to next level: "+e:"Ready to advance!"):d.textContent="Max level reached!"}function N(){r.textContent=`Words: ${p.length-v.length}/`+p.length}function I(e,t){l.textContent=e,l.className="word-feedback "+t}function O(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}function D(e){e.preventDefault(),o=!0;e=c(e.target);null!==e&&(E=[e],h())}function x(e){var t,r;e.preventDefault(),!o||0===E.length||null===(e=c(e.target))||E.includes(e)||(t=E[E.length-1],r=(()=>{if(!(E.length<2)){var e=E[0],t=E[1],r=Math.floor(e/f.gridCols),e=e%f.gridCols,o=Math.floor(t/f.gridCols),t=t%f.gridCols,o=o-r,r=t-e;if(0==o&&0!=r)return{row:0,col:0<r?1:-1};if(0==r&&0!=o)return{row:0<o?1:-1,col:0};if(Math.abs(o)===Math.abs(r))return{row:0<o?1:-1,col:0<r?1:-1}}return null})(),1<E.length&&!((e,t,r)=>{var o,l;if(r)return l=Math.floor(e/f.gridCols),e%=f.gridCols,o=Math.floor(t/f.gridCols),t%=f.gridCols,o-=l,l=t-e,0===r.row?0==o&&l===r.col:0===r.col?0==l&&o===r.row:Math.sign(o)===Math.sign(r.row)&&Math.sign(l)===Math.sign(r.col)&&Math.abs(o)===Math.abs(l)})(t,e,r))||(E.push(e),h())}function b(){o&&(o=!1,s())}function c(e){return e.classList.contains("wordsearch-cell")?parseInt(e.dataset.index):null}function h(){m.forEach(e=>{e.element.classList.remove("selected")}),E.forEach(e=>{m[e].element.classList.add("selected")})}function U(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&D({target:e,preventDefault:()=>{}})}function P(e){e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e&&e.classList.contains("wordsearch-cell")&&x({target:e,preventDefault:()=>{}})}function $(e){e.preventDefault(),b()}i&&(i.appendChild(a),i.appendChild(d)),R(),e.addEventListener("click",R),n.addEventListener("click",function(){var e=p.filter(e=>!v.includes(e.word));0<e.length?I(`Try looking for a word starting with ${e[Math.floor(Math.random()*e.length)].word.slice(0,2)}...`,"info"):I("You found all words!","success")})}document.addEventListener("DOMContentLoaded",()=>{initWordGame()});export{initWordGame};
